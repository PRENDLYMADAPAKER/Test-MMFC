<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Attendance Panel</title>

<!-- ZXing QR Reader (WORKING VERSION from index (1).html) -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>

<style>
  :root {
    --glass: rgba(255,255,255,0.6);
  }
  html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif}
  body{
    background: linear-gradient(135deg,#ffffff 0%,#ffe6f0 45%,#e9d0ff 100%);
    min-height:100vh;
  }

  /* top bar */
  #topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:16px 24px;
  }
  #topbar h1{margin:0;font-size:20px}
  #logo{width:56px;height:56px;object-fit:contain;opacity:0.95}

  /* layout */
  #container{max-width:1200px;margin:18px auto;padding:0 12px;display:flex;gap:20px;flex-wrap:wrap}
  .card{background:rgba(255,255,255,0.58);backdrop-filter:blur(6px);padding:14px;border-radius:6px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  .left{flex:0 0 340px;min-width:280px}
  .right{flex:1;min-width:300px}

  /* scanner */
  #video{width:100%;height:260px;background:#000;border-radius:6px;object-fit:cover}
  .controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  select,input{padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);width:100%}
  button{padding:10px 12px;border-radius:6px;border:0;background:linear-gradient(90deg,#b76bdc,#7b38c3);color:#fff;cursor:pointer}
  button[disabled]{opacity:.55;cursor:not-allowed}

  /* table */
  .table-wrap{overflow:auto;margin-top:8px}
  table{width:100%;border-collapse:collapse;background:transparent}
  th,td{padding:12px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:left;vertical-align:top}
  th{background:rgba(255,255,255,0.25);font-weight:700}
  .time-grid{display:flex;gap:12px;flex-direction:column}
  .small{font-size:12px;color:#555}

  /* toast */
  #toast{position:fixed;right:20px;top:90px;padding:12px 16px;border-radius:8px;color:#fff;display:none;z-index:999}
  #toast.success{background:linear-gradient(90deg,#2ecc71,#27ae60)}
  #toast.error{background:linear-gradient(90deg,#e74c3c,#c0392b)}
</style>
</head>

<body>
  <div id="toast"></div>

  <header id="topbar">
    <h1>Attendance Admin</h1>
    <img id="logo" src="YOUR_LOGO_HERE.png" alt="logo">
  </header>

  <main id="container">

    <!-- LEFT PANEL (Scanner) -->
    <section class="left card">
      <h3 style="margin-bottom:10px">QR Scanner</h3>

      <label for="session">Session</label>
      <select id="session">
        <option value="morning">Morning</option>
        <option value="afternoon">Afternoon</option>
      </select>

      <div class="controls">
        <button id="startBtn">Start Scan</button>
        <button id="stopBtn" disabled>Stop Scan</button>
        <button id="exportBtn">Save CSV</button>
        <button id="printBtn">Print</button>
        <button id="resetBtn">Reset Today (view)</button>
      </div>

      <video id="video" muted playsinline autoplay></video>
      <div class="small" style="margin-top:8px">Camera preview â€” allow camera access.</div>
    </section>

    <!-- RIGHT PANEL (Table) -->
    <section class="right card">
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
        <input id="search" placeholder="Search name | course | year level" style="flex:1" />
        <div style="min-width:120px;text-align:right;color:#444;font-size:13px">Today: <strong id="todayLabel"></strong></div>
      </div>

      <div class="table-wrap card" style="padding:0">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Course</th>
              <th>Year</th>
              <th>Time In</th>
              <th>Time Out</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </section>

  </main>

  <script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, onValue, get, set, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

/* ---------- firebase config (your provided config) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyC7h8wS3Rs6rSZVjUKL8DE9NlqxD3dCIgI",
  authDomain: "dent-dept-dtr.firebaseapp.com",
  databaseURL: "https://dent-dept-dtr-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dent-dept-dtr",
  storageBucket: "dent-dept-dtr.firebasestorage.app",
  messagingSenderId: "537868899036",
  appId: "1:537868899036:web:8dd6dfa10493533616da19",
  measurementId: "G-KD8DF5EDSW"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ---------- UI refs ---------- */
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const exportBtn = document.getElementById('exportBtn');
const printBtn = document.getElementById('printBtn');
const resetBtn = document.getElementById('resetBtn');
const sessionSelect = document.getElementById('session');
const videoEl = document.getElementById('video');
const searchInput = document.getElementById('search');
const tableBody = document.getElementById('tableBody');
const toast = document.getElementById('toast');
const todayLabel = document.getElementById('todayLabel');

/* ---------- Toast ---------- */
function showToast(msg, type='success'){
  toast.textContent = msg;
  toast.className = '';
  toast.classList.add(type==='success' ? 'success' : 'error');
  toast.style.display = 'block';
  setTimeout(()=> toast.style.display='none', 2600);
}

/* ---------- Date key ---------- */
function getDateKey(date = new Date()){
  return date.toISOString().slice(0,10);
}
todayLabel.textContent = getDateKey();

/* ---------- WORKING SCANNER (from index 1) ---------- */
const codeReader = new ZXing.BrowserQRCodeReader();
let scanning = false;

async function startScanner(){
  try {
    if (scanning) return;

    const devices = await codeReader.listVideoInputDevices();
    if (!devices || devices.length === 0){
      showToast("No camera detected", "error");
      return;
    }

    // Prefer back camera
    const backCam = devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];

    scanning = true;
    showToast("Scanner started", "success");

    codeReader.decodeFromVideoDevice(backCam.deviceId, videoEl, (result, err) => {
      if (result && result.getText) {
        handleScannedText(result.getText());
      }
    });

    startBtn.disabled = true;
    stopBtn.disabled = false;

  } catch(err){
    console.error(err);
    showToast("Camera error: " + err.message, "error");
  }
}

function stopScanner(){
  try { codeReader.reset(); } catch(e){}
  scanning = false;
  showToast("Scanner stopped","success");
  startBtn.disabled = false;
  stopBtn.disabled = true;
}

/* ---------- QR Handling ---------- */
async function handleScannedText(text){
  const uid = parseUID(text);
  if(!uid){
    showToast("Invalid QR code", "error");
    return;
  }

  const dateKey = getDateKey();
  const userRef = ref(db, `attendance/${dateKey}/${uid}`);

  try {
    const snap = await get(userRef);
    const data = snap.exists() ? snap.val() : {};
    const now = new Date();
    const stamp = Date.now();
    const display = formatTimeForDisplay(now);

    const sess = sessionSelect.value;

    if (sess === 'morning') {
      if (!data.morningIn) {
        await set(userRef, {...data, morningIn: stamp, date: dateKey});
        showToast(`Morning IN: ${display}`, "success");
        return;
      }
      if (!data.morningOut) {
        await set(userRef, {...data, morningOut: stamp, date: dateKey});
        showToast(`Morning OUT: ${display}`, "success");
        return;
      }
      showToast("Morning already complete", "error");
      return;
    }

    // AFTERNOON
    if (!data.afternoonIn) {
      await set(userRef, {...data, afternoonIn: stamp, date: dateKey});
      showToast(`Afternoon IN: ${display}`, "success");
      return;
    }
    if (!data.afternoonOut) {
      await set(userRef, {...data, afternoonOut: stamp, date: dateKey});
      showToast(`Afternoon OUT: ${display}`, "success");
      return;
    }

    showToast("Afternoon already complete", "error");

  }catch(err){
    console.error(err);
    showToast("Failed saving scan", "error");
  }
}

function parseUID(text){
  try {
    const j = JSON.parse(text);
    if (j && j.uid) return j.uid;
  }catch(e){}
  if (/^[\w-]{3,64}$/.test(text)) return text;
  return null;
}

function formatTimeForDisplay(d){
  let hr = d.getHours() % 12;
  if (hr === 0) hr = 12;
  const min = String(d.getMinutes()).padStart(2,'0');
  const isAM = d.getHours() < 12;
  const suffix = isAM ? 'AM' : 'PM';
  return `${hr}:${min} ${suffix}`;
}

/* ---------- TABLE RENDER ---------- */
let currentTableData = {};

function attachTableListener(){
  const todayRef = ref(db, `attendance/${getDateKey()}`);
  onValue(todayRef, snapshot => {
    currentTableData = snapshot.exists() ? snapshot.val() : {};
    renderTable();
  });
}
attachTableListener();

function renderTable(){
  const q = (searchInput.value||'').toLowerCase();
  tableBody.innerHTML = '';

  const rows = Object.keys(currentTableData).sort();
  if(rows.length === 0){
    tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:20px;">No records today</td></tr>`;
    return;
  }

  for(const uid of rows){
    const rec = currentTableData[uid];
    const name = rec.name || uid;
    const course = rec.course || '';
    const year = rec.year || '';
    const morningIn = rec.morningIn ? formatTimeForDisplay(new Date(rec.morningIn)) : '';
    const morningOut = rec.morningOut ? formatTimeForDisplay(new Date(rec.morningOut)) : '';
    const afternoonIn = rec.afternoonIn ? formatTimeForDisplay(new Date(rec.afternoonIn)) : '';
    const afternoonOut = rec.afternoonOut ? formatTimeForDisplay(new Date(rec.afternoonOut)) : '';
    const date = rec.date || getDateKey();

    const hay = `${name} ${uid} ${course} ${year}`.toLowerCase();
    if(q && !hay.includes(q)) continue;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${name}</td>
      <td>${course}</td>
      <td>${year}</td>
      <td>${morningIn}<br>${afternoonIn}</td>
      <td>${morningOut}<br>${afternoonOut}</td>
      <td>${date}</td>
    `;
    tableBody.appendChild(tr);
  }
}

/* ---------- EXPORT CSV ---------- */
exportBtn.addEventListener('click', () => {
  const rows = [];
  rows.push("Name,Course,Year,Morning In,Morning Out,Afternoon In,Afternoon Out,Date");

  for(const uid of Object.keys(currentTableData)){
    const r = currentTableData[uid];
    rows.push([
      r.name || uid,
      r.course || '',
      r.year || '',
      r.morningIn ? formatTimeForDisplay(new Date(r.morningIn)) : '',
      r.morningOut ? formatTimeForDisplay(new Date(r.morningOut)) : '',
      r.afternoonIn ? formatTimeForDisplay(new Date(r.afternoonIn)) : '',
      r.afternoonOut ? formatTimeForDisplay(new Date(r.afternoonOut)) : '',
      r.date || getDateKey()
    ].join(','));
  }

  const blob = new Blob([rows.join("\n")], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `attendance-${getDateKey()}.csv`;
  a.click();
});

/* ---------- PRINT ---------- */
printBtn.addEventListener('click', ()=> window.print());

/* ---------- RESET VIEW ---------- */
resetBtn.addEventListener('click', ()=>{
  currentTableData = {};
  renderTable();
  showToast("View reset (DB not changed)");
});

/* ---------- Search ---------- */
searchInput.addEventListener('input', renderTable);

/* ---------- Bind buttons ---------- */
startBtn.addEventListener('click', startScanner);
stopBtn.addEventListener('click', stopScanner);

</script>
</body>
</html>
