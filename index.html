<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dentistry Admin Panel</title>

<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>

<style>
:root{
  --primary:#7b38c3;
  --bg:#f6f7fb;
  --card:#ffffff;
}

body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:var(--bg);
}

/* TOP BAR */
#topbar{
  background:#fff;
  border-bottom:3px solid var(--primary);
  padding:12px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

#logo{height:42px}

/* LAYOUT */
#container{
  max-width:1200px;
  margin:20px auto;
  display:flex;
  gap:16px;
  padding:0 12px;
  align-items:flex-start;
}

.card{
  background:var(--card);
  padding:16px;
  border-radius:12px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
}

.left{width:340px}
.right{flex:1; min-width:0}

/* BUTTONS */
button{
  padding:10px 12px;
  border:none;
  background:var(--primary);
  color:#fff;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}
button.ghost{
  background:transparent;
  color:var(--primary);
  border:1px solid var(--primary);
}
button:disabled{
  opacity:.6;
  cursor:not-allowed;
}

/* CONTROLS */
.controls{
  display:flex;
  gap:8px;
  margin-top:10px;
  flex-wrap:wrap;
}

video{
  width:100%;
  height:240px;
  background:#000;
  margin-top:10px;
  border-radius:10px;
}

/* TOAST */
#toast{
  position:fixed;
  top:20px;
  right:20px;
  background:#333;
  color:#fff;
  padding:10px 14px;
  display:none;
  z-index:999;
  border-radius:10px;
}

/* LOGIN */
#loginScreen{
  position:fixed;
  inset:0;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#eee;
}

/* SEARCH */
#search{
  padding:10px;
  width:100%;
  border-radius:10px;
  border:1px solid #ccc;
  margin-bottom:10px;
}

/* TABLE (SCREEN) */
.table-wrap{
  width:100%;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
}

table{
  width:100%;
  min-width:760px; /* mobile horizontal scroll */
  border-collapse:collapse;
  font-size:13px;
}

th,td{
  border:1px solid #000;
  padding:8px 6px;
}

th{
  background:#f1ecfb;
}

/* PRINT HEADER / FOOTER */
.print-header,
.print-footer{
  display:none;
}

/* MOBILE */
@media (max-width:900px){
  #container{flex-direction:column}
  .left,.right{width:100%}
}

/* ======================
   PRINT â€“ FIXED & CLEAN
====================== */
@media print{

  @page{
    size:A4 landscape;
    margin:10mm;
  }

  body{background:#fff}

  #topbar,.left,button,input,select,#toast{
    display:none!important;
  }

  /* Header */
  .print-header{
    display:block;
    text-align:center;
    margin-bottom:16px;
  }

  .print-header h2{
    margin:0;
    letter-spacing:1px;
  }

  .print-header p{
    margin:2px 0;
    font-size:11px;
  }

  .print-header hr{
    margin:10px 0 16px;
    border:none;
    border-top:2px solid #000;
  }

  /* IMPORTANT FIX â€” prevent cut columns */
  .table-wrap{
    overflow:visible!important;
  }

  table{
    width:100%!important;
    min-width:0!important;   /* <-- FIX */
    table-layout:fixed;      /* <-- FIX */
    font-size:10px;
  }

  th,td{
    padding:4px 3px;
    white-space:nowrap;
    text-align:center;
  }

  th{
    background:#eaeaea!important;
    font-size:9px;
    text-transform:uppercase;
  }

  td:first-child,
  td:nth-child(2){
    text-align:left;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* SIGNATURES */
  .print-footer{
    display:flex;
    justify-content:space-between;
    margin-top:30px;
    gap:40px;
  }

  .sign-box{
    width:40%;
    text-align:center;
    font-size:11px;
  }

  .sign-box .line{
    height:30px;
    border-bottom:1px solid #000;
    margin-bottom:6px;
  }

  .sign-box .role{
    font-size:10px;
  }
}
</style>
</head>

<body>

<div id="toast"></div>

<div id="loginScreen">
  <div class="card">
    <h3>Admin Login</h3>
    <input id="loginUser" placeholder="Username"><br><br>
    <input id="loginPass" type="password" placeholder="Password"><br><br>
    <button id="loginBtn">Login</button>
    <div id="loginError" style="color:red;display:none;margin-top:10px">Invalid credentials</div>
  </div>
</div>

<div id="adminApp" style="display:none">

<header id="topbar">
  <div style="display:flex;gap:10px;align-items:center">
    <img id="logo" src="college-logo.png">
    <strong>Dentistry Admin Panel</strong>
  </div>
  <button id="logoutBtn" class="ghost">Logout</button>
</header>

<main id="container">

<section class="left card">
  <h4>QR Scanner</h4>

  <div id="scanStatus" style="font-weight:bold;color:red">ðŸ”´ Scanner stopped</div>

  <select id="session" style="width:100%;padding:10px;border-radius:10px">
    <option value="morning">Morning</option>
    <option value="afternoon">Afternoon</option>
  </select>

  <div class="controls">
    <button id="startBtn">Start</button>
    <button id="stopBtn" class="ghost" disabled>Stop</button>
    <button id="resetBtn" class="ghost">Reset Today</button>
  </div>

  <video id="video" autoplay muted></video>

  <div class="controls">
    <button id="printBtn">Print</button>
  </div>
</section>

<section class="right card">

  <div class="print-header">
    <h2>DAILY ATTENDANCE REPORT</h2>
    <p>Dentistry Department</p>
    <p id="printDate"></p>
    <hr>
  </div>

  <input id="search" placeholder="Search name...">

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Course</th>
          <th>Year</th>
          <th>Morning In</th>
          <th>Morning Out</th>
          <th>Afternoon In</th>
          <th>Afternoon Out</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div class="print-footer">
    <div class="sign-box">
      <div class="line"></div>
      <strong>Prepared By</strong>
      <div class="role">Name / Signature</div>
    </div>

    <div class="sign-box">
      <div class="line"></div>
      <strong>Verified By</strong>
      <div class="role">Name / Signature</div>
    </div>
  </div>

</section>

</main>
</div>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, get, set, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const LOGIN_USER="admin";
const LOGIN_PASS="admin123";
const AUTO_LOGOUT_MS=5*60*1000;

const el=id=>document.getElementById(id);
const toast=el("toast");

function showToast(msg){
  toast.textContent=msg;
  toast.style.display="block";
  setTimeout(()=>toast.style.display="none",2500);
}

/* LOGIN */
let logoutTimer;
function resetTimer(){
  clearTimeout(logoutTimer);
  logoutTimer=setTimeout(logout,AUTO_LOGOUT_MS);
}
["click","mousemove","keydown","touchstart"].forEach(e=>{
  document.addEventListener(e,()=>sessionStorage.getItem("admin")&&resetTimer(),{passive:true});
});

el("loginBtn").onclick=()=>{
  if(el("loginUser").value===LOGIN_USER && el("loginPass").value===LOGIN_PASS){
    sessionStorage.setItem("admin","1");
    el("loginScreen").style.display="none";
    el("adminApp").style.display="block";
    resetTimer();
  }else el("loginError").style.display="block";
};

function logout(){
  sessionStorage.clear();
  location.reload();
}
el("logoutBtn").onclick=logout;

if(sessionStorage.getItem("admin")==="1"){
  el("loginScreen").style.display="none";
  el("adminApp").style.display="block";
  resetTimer();
}

/* FIREBASE */
const app=initializeApp({
  apiKey:"AIzaSyC7h8wS3Rs6rSZVjUKL8DE9NlqxD3dCIgI",
  databaseURL:"https://dent-dept-dtr-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db=getDatabase(app);

const today=new Date().toISOString().slice(0,10);
el("printDate").textContent=`Date: ${today}`;

const ADMIN_PATH=`adminAttendance/${today}`;
const USER_PATH=`attendance/${today}`;

let store={};
onValue(ref(db,ADMIN_PATH),s=>{
  store=s.exists()?s.val():{};
  render();
});

function fmt(t){ return t?new Date(t).toLocaleTimeString():""; }

function render(){
  const q=(el("search").value||"").toLowerCase();
  el("tableBody").innerHTML=Object.values(store)
    .filter(r=>(r.name||"").toLowerCase().includes(q))
    .map(r=>`
      <tr>
        <td>${r.name||""}</td>
        <td>${r.course||""}</td>
        <td>${r.year||""}</td>
        <td>${fmt(r.morningIn)}</td>
        <td>${fmt(r.morningOut)}</td>
        <td>${fmt(r.afternoonIn)}</td>
        <td>${fmt(r.afternoonOut)}</td>
      </tr>`).join("");
}

el("search").oninput=render;
el("printBtn").onclick=()=>window.print();
</script>

</body>
</html>
