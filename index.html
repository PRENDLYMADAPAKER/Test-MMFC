<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dentistry Admin Panel</title>

<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>

<style>
:root{
  --primary:#7b38c3;
  --bg:#f6f7fb;
  --card:#ffffff;
}

body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:var(--bg);
}

/* ===== TOP BAR ===== */
#topbar{
  background:#fff;
  border-bottom:3px solid var(--primary);
  padding:12px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
#logo{height:42px}

/* ===== LAYOUT ===== */
#container{
  max-width:1200px;
  margin:20px auto;
  display:flex;
  gap:16px;
  padding:0 12px;
  align-items:flex-start;
}
.left{width:340px}
.right{flex:1;min-width:0}

/* ===== CARDS ===== */
.card{
  background:var(--card);
  padding:16px;
  border-radius:12px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
}

/* ===== BUTTONS ===== */
button{
  padding:10px 12px;
  border:none;
  background:var(--primary);
  color:#fff;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}
button.ghost{
  background:transparent;
  color:var(--primary);
  border:1px solid var(--primary);
}
button:disabled{opacity:.6}

/* ===== CONTROLS ===== */
.controls{
  display:flex;
  gap:8px;
  margin-top:10px;
  flex-wrap:wrap;
}

/* ===== VIDEO ===== */
video{
  width:100%;
  height:240px;
  background:#000;
  margin-top:10px;
  border-radius:10px;
}

/* ===== SEARCH ===== */
#search{
  padding:10px;
  width:100%;
  border-radius:10px;
  border:1px solid #ccc;
  margin-bottom:10px;
}

/* ===== TABLE ===== */
.table-wrap{
  width:100%;
  overflow-x:auto;
}
table{
  width:100%;
  min-width:760px;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  border:1px solid #000;
  padding:8px;
}
th{
  background:#f1ecfb;
  font-weight:700;
}

/* ===== TOAST ===== */
#toast{
  position:fixed;
  top:20px;
  right:20px;
  background:#333;
  color:#fff;
  padding:10px 14px;
  display:none;
  z-index:999;
  border-radius:10px;
}

/* ===== LOGIN ===== */
#loginScreen{
  position:fixed;
  inset:0;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#eee;
}
#loginScreen input{
  padding:10px;
  width:260px;
  border-radius:8px;
  border:1px solid #ccc;
}

/* ===== PRINT HEADER ===== */
.print-header,.print-footer{display:none}

/* ===== MOBILE ===== */
@media (max-width:900px){
  #container{flex-direction:column}
  .left,.right{width:100%}
  video{height:220px}
}

/* ===== PRINT (PROFESSIONAL) ===== */
@media print{
  #topbar,.left,#toast,button,input,select,#search{display:none!important}
  body{background:#fff}
  #container{margin:0;padding:0;max-width:none}
  .card{box-shadow:none;padding:0}
  .print-header{
    display:block;
    text-align:center;
    margin-bottom:12px;
    border-bottom:2px solid #000;
    padding-bottom:10px;
  }
  .print-header h2{margin:0;font-size:18px}
  .print-header p{margin:4px 0;font-size:12px}
  table{
    width:100%;
    min-width:0;
    font-size:11px;
  }
  th{
    background:#eee;
    text-transform:uppercase;
    font-size:10px;
  }
  tr{page-break-inside:avoid}
  .print-footer{
    display:block;
    margin-top:18px;
  }
  .sig-line{
    display:flex;
    gap:24px;
  }
  .sig{
    flex:1;
    border-top:1px solid #000;
    padding-top:6px;
    text-align:center;
    font-size:11px;
  }
}
</style>
</head>

<body>

<div id="toast"></div>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="card">
    <h3>Admin Login</h3>
    <input id="loginUser" placeholder="Username"><br><br>
    <input id="loginPass" type="password" placeholder="Password"><br><br>
    <button id="loginBtn">Login</button>
    <div id="loginError" style="color:red;display:none;margin-top:10px">Invalid credentials</div>
  </div>
</div>

<div id="adminApp" style="display:none">

<header id="topbar">
  <div style="display:flex;align-items:center;gap:10px">
    <img id="logo" src="college-logo.png">
    <strong>Dentistry Admin Panel</strong>
  </div>
  <button id="logoutBtn" class="ghost">Logout</button>
</header>

<main id="container">

<section class="left card">
  <h4>QR Scanner</h4>
  <div id="scanStatus" style="font-weight:700;color:#e74c3c">üî¥ Scanner stopped</div>

  <select id="session" style="padding:10px;width:100%;border-radius:8px">
    <option value="morning">Morning</option>
    <option value="afternoon">Afternoon</option>
  </select>

  <div class="controls">
    <button id="startBtn">Start</button>
    <button id="stopBtn" class="ghost" disabled>Stop</button>
    <button id="resetBtn" class="ghost">Reset Today</button>
  </div>

  <video id="video" autoplay muted></video>

  <div class="controls">
    <button id="printBtn">Print</button>
  </div>
</section>

<section class="right card">

  <div class="print-header">
    <h2>Daily Attendance Report</h2>
    <p id="printDate"></p>
    <p id="printMeta"></p>
  </div>

  <input id="search" placeholder="Search name...">

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Name</th><th>Course</th><th>Year</th>
          <th>Morning In</th><th>Morning Out</th>
          <th>Afternoon In</th><th>Afternoon Out</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div class="print-footer">
    <div class="sig-line">
      <div class="sig">Prepared By</div>
      <div class="sig">Verified By</div>
    </div>
  </div>

</section>

</main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, get, set, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ===== CONFIG ===== */
const LOGIN_USER="admin";
const LOGIN_PASS="admin123";
const AUTO_LOGOUT_MS=5*60*1000;

/* ===== HELPERS ===== */
const el=id=>document.getElementById(id);
const toast=el("toast");
const scanStatus=el("scanStatus");

function showToast(msg){
  toast.textContent=msg;
  toast.style.display="block";
  setTimeout(()=>toast.style.display="none",2500);
}
function setScanStatus(t,c){scanStatus.textContent=t;scanStatus.style.color=c}

/* ===== LOGIN ===== */
let logoutTimer;
function resetTimer(){
  clearTimeout(logoutTimer);
  logoutTimer=setTimeout(()=>logout(),AUTO_LOGOUT_MS);
}
["click","mousemove","keydown","touchstart"].forEach(e=>{
  document.addEventListener(e,()=>sessionStorage.getItem("admin")&&resetTimer(),{passive:true});
});
el("loginBtn").onclick=()=>{
  if(el("loginUser").value===LOGIN_USER && el("loginPass").value===LOGIN_PASS){
    sessionStorage.setItem("admin","1");
    el("loginScreen").style.display="none";
    el("adminApp").style.display="block";
    resetTimer();
  }else el("loginError").style.display="block";
};
function logout(){sessionStorage.clear();stopScanner();location.reload()}
el("logoutBtn").onclick=logout;
if(sessionStorage.getItem("admin")==="1"){
  el("loginScreen").style.display="none";
  el("adminApp").style.display="block";
  resetTimer();
}

  /* ===== FIREBASE ===== */
const app=initializeApp({
  apiKey:"AIzaSyC7h8wS3Rs6rSZVjUKL8DE9NlqxD3dCIgI",
  databaseURL:"https://dent-dept-dtr-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db=getDatabase(app);

/* ===== DATE ===== */
const today=new Date().toISOString().slice(0,10);
el("printDate").textContent=`Date: ${today}`;
el("printMeta").textContent=`Generated: ${new Date().toLocaleString()}`;
const ADMIN_PATH=`adminAttendance/${today}`;

/* ===== SCANNER ===== */
const reader=new ZXing.BrowserQRCodeReader();
let scanning=false;
let lastScan={uid:null,ts:0};

async function startScanner(){
  if(scanning) return;
  const cams=await reader.listVideoInputDevices();
  const cam=cams.find(c=>/rear|back|env/i.test(c.label))||cams[0];
  reader.decodeFromVideoDevice(cam.deviceId,el("video"),res=>{
    if(res) handleScan(res.getText());
  });
  scanning=true;
  el("startBtn").disabled=true;
  el("stopBtn").disabled=false;
  setScanStatus("üü¢ Scanner active","#2ecc71");
}
function stopScanner(){
  reader.reset();
  scanning=false;
  el("startBtn").disabled=false;
  el("stopBtn").disabled=true;
  setScanStatus("üî¥ Scanner stopped","#e74c3c");
}
el("startBtn").onclick=startScanner;
el("stopBtn").onclick=stopScanner;

/* ===== DATA ===== */
let store={};
onValue(ref(db,ADMIN_PATH),s=>{
  store=s.exists()?s.val():{};
  render();
});

/* ===== SCAN LOGIC ===== */
async function handleScan(txt){
  setScanStatus("‚è≥ Processing scan...","#f39c12");
  let qr;
  try{qr=JSON.parse(txt)}catch{return}
  const now=Date.now();
  if(qr.uid===lastScan.uid && now-lastScan.ts<2000) return;
  lastScan={uid:qr.uid,ts:now};

  const userSnap=await get(ref(db,`users/${qr.uid}`));
  if(!userSnap.exists()){showToast("Student not found");return;}

  const row=store[qr.uid]||{};
  const sess=el("session").value;
  const inK=sess==="morning"?"morningIn":"afternoonIn";
  const outK=sess==="morning"?"morningOut":"afternoonOut";

  if(qr.mode==="out" && !row[inK]){showToast("Time-In required");return;}

  const key=qr.mode==="in"?inK:outK;
  if(row[key]){showToast("Already recorded");return;}

  await set(ref(db,`${ADMIN_PATH}/${qr.uid}`),{
    ...row,
    ...userSnap.val(),
    [key]:now
  });

  showToast("Recorded");
  setScanStatus("üü¢ Ready","#2ecc71");
}

/* ===== RENDER ===== */
function fmt(t){return t?new Date(t).toLocaleTimeString():""}
function render(){
  const q=(el("search").value||"").toLowerCase();
  el("tableBody").innerHTML=Object.values(store)
    .filter(r=>(r.name||"").toLowerCase().includes(q))
    .map(r=>{
      const missM=r.morningIn&&!r.morningOut;
      const missA=r.afternoonIn&&!r.afternoonOut;
      return `
      <tr style="${missM||missA?'background:#fff3f3':''}">
        <td>${r.name}</td>
        <td>${r.course}</td>
        <td>${r.year}</td>
        <td>${fmt(r.morningIn)}</td>
        <td style="color:${missM?'red':''}">${fmt(r.morningOut)}</td>
        <td>${fmt(r.afternoonIn)}</td>
        <td style="color:${missA?'red':''}">${fmt(r.afternoonOut)}</td>
      </tr>`;
    }).join("");
}
el("search").oninput=render;

/* ===== RESET ===== */
el("resetBtn").onclick=async()=>{
  const pass=prompt("Enter admin password:");
  if(pass!==LOGIN_PASS){showToast("Wrong password");return;}

  let csv="Name,Course,Year,Morning In,Morning Out,Afternoon In,Afternoon Out\n";
  Object.values(store).forEach(r=>{
    csv+=`${r.name},${r.course},${r.year},${fmt(r.morningIn)},${fmt(r.morningOut)},${fmt(r.afternoonIn)},${fmt(r.afternoonOut)}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`attendance_${today}.csv`;
  a.click();

  if(!confirm("Reset ADMIN records for today?")) return;
  await remove(ref(db,ADMIN_PATH));
  showToast("Admin records reset");
};

el("printBtn").onclick=()=>window.print();
</script>

  <style>
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    margin: 0;
  }

  footer.page-footer {
    text-align: center;
    width: 100%;
    padding: 10px 0;
    font-family: 'Poppins', Arial, sans-serif;
    font-size: 13px;
    color: #5a437c;
    opacity: 0.85;
    margin-top: auto;
  }
</style>

<footer class="page-footer">
  Created by <strong>NZM</strong><br>
  &copy; 2025 | To God Be the Glory
</footer>

</body>
</html>
