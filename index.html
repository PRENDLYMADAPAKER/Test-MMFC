<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Admin Attendance Panel</title>

<!-- ZXing QR Reader -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>

<style>
/* -------------------------------------------------------
   THEME — Modern Glass + Mobile Optimized
------------------------------------------------------- */
:root{
  --bg1:#ffffff;
  --bg2:#ffe6f0;
  --accent1:#b76bdc;
  --accent2:#7b38c3;
  --muted:#666;
  --shadow:0 10px 30px rgba(59,20,88,0.08);
  --radius:14px;
  --maxw:1200px;
}

html,body{
  margin:0;
  height:100%;
  font-family:Inter, Arial, sans-serif;
  -webkit-font-smoothing:antialiased;
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
}

/* Background improved on mobile */
@media (max-width:600px){
  body{
    background:linear-gradient(180deg,#ffffff,#ffe6f0 60%);
    padding:10px;
  }
}

/* -------------------------------------------------------
   Top Bar
------------------------------------------------------- */
#topbar{
  max-width:var(--maxw);
  margin:0 auto 16px;
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-radius:var(--radius);
  background:rgba(255,255,255,0.55);
  backdrop-filter:blur(6px);
  box-shadow:var(--shadow);
}
#logo{
  width:52px;
  height:52px;
  object-fit:contain;
  background:rgba(255,255,255,0.6);
  border-radius:10px;
}

/* -------------------------------------------------------
   Layout (Desktop)
------------------------------------------------------- */
#container{
  max-width:var(--maxw);
  margin:0 auto;
  display:flex;
  gap:18px;
  flex-wrap:nowrap;
}

/* Cards */
.card{
  border-radius:var(--radius);
  background:rgba(255,255,255,0.58);
  backdrop-filter:blur(9px);
  padding:16px;
  box-shadow:var(--shadow);
}

/* -------------------------------------------------------
   MOBILE LAYOUT OPTION A — Compact
------------------------------------------------------- */
@media (max-width:820px){
  #container{
    flex-direction:column;
  }
  .left, .right{
    width:100% !important;
    min-width:0 !important;
  }
}

/* Left Panel */
.left{
  flex:0 0 360px;
  min-width:260px;
}
@media (max-width:820px){
  .left{
    flex:1;
  }
}

/* Right Panel */
.right{
  flex:1;
  min-width:300px;
  display:flex;
  flex-direction:column;
}

/* -------------------------------------------------------
   Scanner / Inputs
------------------------------------------------------- */
#video{
  width:100%;
  height:260px;
  background:#000;
  border-radius:12px;
  object-fit:cover;
}

label{
  font-size:13px;
  margin-bottom:6px;
  color:var(--muted);
}

input,select{
  width:100%;
  padding:11px;
  border-radius:10px;
  border:1px solid rgba(0,0,0,0.1);
  background:#fff;
}

#search{
  padding:13px;
  border-radius:12px;
}

.controls{
  margin-top:10px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}

button{
  padding:12px 16px;
  border:none;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
  background:linear-gradient(90deg,var(--accent1),var(--accent2));
  color:#fff;
  flex:1;
}

button.ghost{
  background:white;
  color:var(--accent2);
  border:1px solid rgba(0,0,0,0.1);
}

button[disabled]{opacity:.5}

/* MOBILE: buttons stack neatly */
@media(max-width:600px){
  button{
    flex:100%;
  }
}

/* -------------------------------------------------------
   Table
------------------------------------------------------- */
.table-wrap{
  overflow:auto;
  margin-top:10px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,0.08);
}

table{
  width:100%;
  border-collapse:collapse;
  min-width:700px;
}

thead th{
  position:sticky;
  top:0;
  background:rgba(255,255,255,0.9);
  padding:12px;
  font-weight:700;
}

tbody td{
  padding:12px;
  border-bottom:1px solid rgba(0,0,0,0.05);
}

tbody tr:nth-child(even){
  background:rgba(255,255,255,0.4);
}

/* Summary Bar */
#summaryBar{
  margin-top:14px;
  padding:12px;
  border-radius:12px;
  background:rgba(255,255,255,0.55);
  display:flex;
  justify-content:space-between;
}

/* MOBILE: summary bar vertical */
@media(max-width:600px){
  #summaryBar{
    flex-direction:column;
    gap:8px;
    text-align:center;
  }
}

/* -------------------------------------------------------
   Toast
------------------------------------------------------- */
#toast{
  position:fixed;
  right:12px;
  top:80px;
  padding:10px 14px;
  border-radius:10px;
  color:#fff;
  display:none;
  z-index:9999;
}
#toast.success{background:#2ecc71}
#toast.error{background:#e74c3c}

/* -------------------------------------------------------
   PRINT MODE
------------------------------------------------------- */
#printHeader{display:none}

@media print{
  body *{visibility:hidden;}

  #printHeader, #printArea, #printArea *{
    visibility:visible;
  }

  #printHeader{
    position:fixed;
    top:0; left:0;
    width:100%;
    padding:10px;
    background:white;
    z-index:1000;
    border-bottom:1px solid #ccc;
  }

  #printArea{
    position:fixed;
    top:120px; left:0;
    width:100%;
    padding:0 12px;
  }

  table{
    width:100%;
    min-width:0;
    border-collapse:collapse;
  }

  th,td{
    border:1px solid #ccc !important;
    padding:8px !important;
    color:#000 !important;
    background:white !important;
  }

   /* ---------------------------------------
   CENTER TILES ON MOBILE
--------------------------------------- */
@media (max-width: 820px) {

  #container {
    align-items: center; /* centers stacked tiles */
  }

  .card,
  .left,
  .right {
    max-width: 500px;
    width: 100%;
    margin: 0 auto;
  }

  .card {
    margin-bottom: 14px;
  }
}
</style>
</head>

<body>

<div id="toast"></div>

<!-- PRINT HEADER -->
<div id="printHeader">
  <div style="display:flex;align-items:center;gap:12px;">
    <img id="printLogo" src="college-logo.png" style="
      width:64px;height:64px;object-fit:contain;border-radius:10px;">
    <div>
      <div style="font-size:20px;font-weight:700;">Clinic Attendance Report</div>
      <div id="printMeta" style="font-size:13px;color:#444;"></div>
    </div>
  </div>
</div>

<header id="topbar">
  <h1>Attendance Admin</h1>
  <img id="logo" src="college-logo.png">
</header>

<main id="container">

<!-- LEFT PANEL -->
<section class="left card">
  <h3>QR Scanner</h3>

  <label>Session</label>
  <select id="session">
    <option value="morning">Morning</option>
    <option value="afternoon">Afternoon</option>
  </select>

  <div class="controls">
    <button id="startBtn">Start Scan</button>
    <button id="stopBtn" class="ghost" disabled>Stop</button>
    <button id="resetBtn" class="ghost">Reset Today</button>
  </div>

  <video id="video" muted playsinline autoplay></video>
  <div class="muted" style="margin-top:8px;">Camera preview — allow access.</div>

  <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;">
    <button id="exportBtn">Save CSV</button>
    <button id="printBtn">Print</button>
  </div>
</section>

<!-- RIGHT PANEL -->
<section class="right">
  <div class="card" style="display:flex;gap:12px;align-items:center;margin-bottom:10px;">
    <input id="search" placeholder="Search name | course | year">
    <div style="font-size:13px;color:#444;">Today: <strong id="todayLabel"></strong></div>
  </div>

  <div class="card table-wrap" style="padding:0;">
    <div id="printArea" style="padding:12px;">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Course</th>
            <th>Year</th>
            <th>Morning In</th>
            <th>Morning Out</th>
            <th>Afternoon In</th>
            <th>Afternoon Out</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <div id="summaryBar">
    <div>Records shown: <strong id="countShown">0</strong></div>
    <div>Total today: <strong id="totalCount">0</strong></div>
  </div>
</section>

  </main>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ---------------------------------------
   FIREBASE CONFIG (unchanged)
--------------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyC7h8wS3Rs6rSZVjUKL8DE9NlqxD3dCIgI",
  authDomain: "dent-dept-dtr.firebaseapp.com",
  databaseURL: "https://dent-dept-dtr-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dent-dept-dtr",
  storageBucket: "dent-dept-dtr.firebasestorage.app",
  messagingSenderId: "537868899036",
  appId: "1:537868899036:web:8dd6dfa10493533616da19",
  measurementId: "G-KD8DF5EDSW"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ---------------------------------------
   UI ELEMENTS
--------------------------------------- */
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const resetBtn = document.getElementById("resetBtn");
const exportBtn = document.getElementById("exportBtn");
const printBtn = document.getElementById("printBtn");

const sessionSelect = document.getElementById("session");
const video = document.getElementById("video");

const tableBody = document.getElementById("tableBody");
const searchEl = document.getElementById("search");
const todayLabel = document.getElementById("todayLabel");

const countShown = document.getElementById("countShown");
const totalCount = document.getElementById("totalCount");

/* PRINT ELEMENTS */
const printMeta = document.getElementById("printMeta");
const printLogo = document.getElementById("printLogo");
const screenLogo = document.getElementById("logo");

/* Toast */
const toast = document.getElementById("toast");
function showToast(msg, type="success"){
  toast.textContent = msg;
  toast.className = type;
  toast.style.display="block";
  setTimeout(()=>toast.style.display="none",2000);
}

/* ---------------------- Date -------------------- */
function getDateKey(d=new Date()){
  return d.toISOString().slice(0,10);
}
todayLabel.textContent = getDateKey();

/* ---------------------- Scanner -------------------- */
const codeReader = new ZXing.BrowserQRCodeReader();
let scanning = false;

async function startScanner(){
  try{
    if(scanning) return;
    const devices = await codeReader.listVideoInputDevices();
    if(!devices.length){ showToast("No camera","error"); return; }

    const backCam = devices.find(d=>/back|rear|env/i.test(d.label)) || devices[0];
    scanning = true;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    showToast("Scanner started");

    // decodeFromVideoDevice will call our callback on every detection
    codeReader.decodeFromVideoDevice(backCam.deviceId, video, (result)=>{
      if(result && result.getText) handleScan(result.getText());
    });

  }catch(e){
    showToast("Camera error","error");
  }
}

function stopScanner(){
  codeReader.reset();
  scanning = false;
  startBtn.disabled = false;
  stopBtn.disabled = true;
  showToast("Scanner stopped");
}

/* ---------------------- Parse QR (returns object with uid and mode) -------------------- */
function parseQR(text){
  try{
    const j = JSON.parse(text);
    // Expecting { uid: "...", mode: "in" | "out" }
    if(j && j.uid && (j.mode === "in" || j.mode === "out")) return j;
  }catch(e){}
  // Not a JSON QR we recognize
  return null;
}

/* ---------------------- Handle Scan (uses mode + fetches profile) -------------------- */
let lastProcessed = { uid: null, mode: null, ts: 0 }; // simple debounce to avoid duplicate immediate reads

async function handleScan(text){
  const qr = parseQR(text);
  if(!qr){
    showToast("Invalid QR","error");
    return;
  }

  const uid = qr.uid;
  const mode = qr.mode; // "in" or "out"

  // Debounce: ignore same uid+mode scanned within 1.5s to avoid double-processing
  const nowTs = Date.now();
  if(lastProcessed.uid === uid && lastProcessed.mode === mode && (nowTs - lastProcessed.ts) < 1500){
    return;
  }
  lastProcessed = { uid, mode, ts: nowTs };

  const dateKey = getDateKey();
  const refUser = ref(db,`attendance/${dateKey}/${uid}`);

  try{
    // Read existing attendance record for uid (if any)
    const snap = await get(refUser);
    const data = snap.exists()? snap.val() : {};

    // Fetch profile from users/{uid} (if available)
    const userProfileSnap = await get(ref(db, `users/${uid}`));
    const profile = userProfileSnap.exists() ? userProfileSnap.val() : {};

    const now = new Date();
    const stamp = Date.now();
    const sess = sessionSelect.value; // "morning" | "afternoon"

    // Helper to save and include profile fields
    async function save(field){

  // Ensure profile is loaded
  if (!profile || !profile.name) {
    const profileSnap = await get(ref(db, `users/${uid}`));
    if (profileSnap.exists()) profile = profileSnap.val();
  }

  const payload = {
    ...data,
    [field]: stamp,
    date: dateKey,

    name: profile?.name || "Unknown",
    course: profile?.course || "",
    year: profile?.year || ""
  };

  await set(refUser, payload);

  showToast(
    (field.includes("In") ? "Time In: " : "Time Out: ") + formatTime(now)
  );
    }

    // Decide based on QR mode
    if(mode === "in"){
      if(sess === "morning"){
        if(!data.morningIn) return await save("morningIn");
        return showToast("Morning In already recorded","error");
      }else{ // afternoon
        if(!data.afternoonIn) return await save("afternoonIn");
        return showToast("Afternoon In already recorded","error");
      }
    }

    if(mode === "out"){
      if(sess === "morning"){
        if(!data.morningIn) return showToast("No Morning Time In yet","error");
        if(!data.morningOut) return await save("morningOut");
        return showToast("Morning Out already recorded","error");
      }else{ // afternoon
        if(!data.afternoonIn) return showToast("No Afternoon Time In yet","error");
        if(!data.afternoonOut) return await save("afternoonOut");
        return showToast("Afternoon Out already recorded","error");
      }
    }

    // If mode somehow not 'in' or 'out'
    showToast("Unknown QR mode","error");

  }catch(e){
    console.error(e);
    showToast("Save failed","error");
  }
}

function formatTime(d){
  let h=d.getHours()%12; if(h===0)h=12;
  let m=String(d.getMinutes()).padStart(2,'0');
  return `${h}:${m} ${d.getHours()<12?"AM":"PM"}`;
}

/* ---------------------- Table Renderer -------------------- */
let tableData={};

function attach(){
  const r = ref(db,`attendance/${getDateKey()}`);
  onValue(r,snap=>{
    tableData = snap.exists()?snap.val():{};
    render();
  });
}
attach();

function escapeHTML(s){return String(s||"")
  .replaceAll("&","&amp;")
  .replaceAll("<","&lt;")
  .replaceAll(">","&gt;")}

function render(){
  const q = searchEl.value.toLowerCase();
  tableBody.innerHTML = "";

  const keys = Object.keys(tableData).sort();
  if(!keys.length){
    tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:20px;">No records</td></tr>`;
    countShown.textContent = 0;
    totalCount.textContent = 0;
    return;
  }

  let shown=0;

  for(const uid of keys){
    const r = tableData[uid] || {};

    // If the attendance record doesn't have name/course/year, try to show uid as fallback
    const name = r.name || uid;
    const course = r.course || "";
    const year = r.year || "";

    const hay = `${name} ${uid} ${course} ${year}`.toLowerCase();
    if(q && !hay.includes(q)) continue;

    const morningIn = r.morningIn ? formatTime(new Date(r.morningIn)) : "";
    const morningOut = r.morningOut ? formatTime(new Date(r.morningOut)) : "";
    const afternoonIn = r.afternoonIn ? formatTime(new Date(r.afternoonIn)) : "";
    const afternoonOut = r.afternoonOut ? formatTime(new Date(r.afternoonOut)) : "";

    const row = document.createElement("tr");
    row.innerHTML = `
  <td>${escapeHTML(name)}</td>
  <td>${escapeHTML(course)}</td>
  <td>${escapeHTML(year)}</td>
  <td>${morningIn}</td>
  <td>${morningOut}</td>
  <td>${afternoonIn}</td>
  <td>${afternoonOut}</td>
  <td>${escapeHTML(r.date || getDateKey())}</td>
`;
    tableBody.appendChild(row);
    shown++;
  }

  countShown.textContent = shown;
  totalCount.textContent = keys.length;
}

searchEl.addEventListener("input",render);

/* ---------------------- Export CSV -------------------- */
exportBtn.addEventListener("click",()=>{
  const q = searchEl.value.toLowerCase();
  const lines=["Name,Course,Year,Morning In,Morning Out,Afternoon In,Afternoon Out,Date"];

  for(const uid of Object.keys(tableData)){
    const r = tableData[uid] || {};
    const name = r.name || uid;
    const course = r.course || "";
    const year = r.year || "";
    const hay = `${name} ${uid} ${course} ${year}`.toLowerCase();
    if(q && !hay.includes(q)) continue;

    lines.push([
  `"${name.replaceAll('"','""')}"`,
  `"${(course||"").replaceAll('"','""')}"`,
  `"${(year||"").replaceAll('"','""')}"`,
  morningIn,
  morningOut,
  afternoonIn,
  afternoonOut,
  r.date || getDateKey()
].join(","));
  }

  const blob=new Blob([lines.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`attendance-${getDateKey()}.csv`;
  a.click();
});

/* ---------------------- Print -------------------- */
function preparePrint(){
  printLogo.src = screenLogo.src;
  const sess = sessionSelect.value.charAt(0).toUpperCase()+sessionSelect.value.slice(1);
  printMeta.textContent = `Date: ${getDateKey()} | Session: ${sess}`;
}

printBtn.addEventListener("click",()=>{
  preparePrint();
  setTimeout(()=>window.print(),150);
});

/* ---------------------- Reset -------------------- */
resetBtn.addEventListener("click",()=>{
  tableData={};
  render();
  showToast("View reset");
});

/* ---------------------- Bind scanner -------------------- */
startBtn.addEventListener("click",startScanner);
stopBtn.addEventListener("click",stopScanner);
</script>

</body>
</html>
