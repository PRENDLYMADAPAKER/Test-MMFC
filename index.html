<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CI ADMIN PANEL ‚Äî Enhanced</title>
  <style>
    :root {
      --bg-start: #ffd6f0; /* soft pink */
      --bg-mid: #ffffff;   /* white */
      --bg-end: #d6b8ff;  /* soft purple */
      --panel: rgba(15,23,36,0.85);
      --muted: #5b6b7a;
      --accent: #6b21a8;
      --success: #16a34a;
      --warn: #d97706;
      --danger: #dc2626;
    }
    html,body { height:100%; margin:0; font-family:Inter, Arial, sans-serif; color:#0b1220; }
    body{
      /* smooth diagonal gradient mix pink -> white -> purple */
      background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-mid) 45%, var(--bg-end) 100%);
    }
    header{
      background: rgba(255,255,255,0.6);
      padding:12px 20px; display:flex; align-items:center; justify-content:space-between; backdrop-filter: blur(6px);
      box-shadow: 0 4px 14px rgba(2,6,23,0.08);
    }
    header h1{ margin:0; font-size:18px; color:#2b0b3a }
    #logo{ height:36px; width:auto; border-radius:6px; }
    #clock{ font-family:monospace; color:var(--muted); }
    main{ max-width:1200px; margin:18px auto; padding:12px; display:grid; grid-template-columns:1fr 1fr; gap:16px; box-sizing:border-box; }
    .card{ background: rgba(255,255,255,0.85); padding:16px; border-radius:12px; box-shadow:0 6px 18px rgba(11,17,32,0.06); }
    #video{ width:100%; max-width:360px; border-radius:8px; background:#000; display:block; margin:0 auto; }
    #result{ margin-top:12px; text-align:center; font-weight:600; min-height:28px; }
    .controls{ display:flex; gap:10px; justify-content:center; margin-top:14px; flex-wrap:wrap }
    button{ background:linear-gradient(90deg,#ff8acb,#8b5cf6); color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:700 }
    button[disabled]{ opacity:.6; cursor:not-allowed }
    .action-btn{ background:#7c3aed; color:#fff; padding:8px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:700 }
    .reset-btn{ background:var(--danger); color:#fff }
    input, select{ padding:8px; border-radius:8px; border:1px solid rgba(11,17,32,0.06); min-width:120px }
    .form-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:14px }
    th,td{ padding:10px; border-bottom:1px solid rgba(11,17,32,0.06); text-align:left }
    th{ background: rgba(11,17,32,0.02); cursor:pointer }
    tr:nth-child(even){ background: rgba(11,17,32,0.02) }
    .no-records{ text-align:center; color:var(--muted); padding:18px }
    label.small{ font-size:12px; color:var(--muted) }
    @media (max-width:980px){ main{ grid-template-columns:1fr; padding:12px } #video{ max-width:280px } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:12px">
      <h1>üìã Admin DTR Panel ‚Äî Clinical Instructor (Option B)</h1>
    </div>
    <div style="display:flex;align-items:center;gap:12px">
      <div id="clock">--:--:--</div>
      <!-- Fit logo top-right -->
      <img id="logo" src="https://via.placeholder.com/120x36?text=Logo" alt="Logo" />
    </div>
  </header>  <main>
    <section class="card" id="scanner-card">
      <video id="video" muted autoplay playsinline></video>
      <div id="result">Scanner idle</div><div id="profile" aria-live="polite" style="margin-top:12px;display:none">
    <div><strong>Name:</strong> <span id="profile-name"></span></div>
    <div><strong>Email:</strong> <span id="profile-email"></span></div>
    <div><strong>Mode:</strong> <span id="profile-mode"></span></div>
    <div><strong>Period:</strong> <span id="profile-period"></span></div>
    <div><strong>Status:</strong> <span id="profile-status"></span></div>
  </div>

  <div class="controls">
    <button id="start-btn">Start Scanner</button>
    <button id="stop-btn" disabled>Stop Scanner</button>
  </div>

  <hr style="margin:12px 0" />

  <!-- Settings: Event, OnTime thresholds, Late thresholds -->
  <div>
    <h3 style="margin:6px 0 8px 0">Event & Time Settings</h3>
    <div class="form-row" style="margin-bottom:8px">
      <input id="event-input" placeholder="Event name (e.g., Midterm Rounds)" />
      <button id="save-event" class="action-btn">Save Event</button>
    </div>
    <div class="form-row" style="margin-bottom:8px">
      <div>
        <label class="small">Morning On-time (HH:MM)</label><br>
        <input id="morning-on" placeholder="08:00" />
      </div>
      <div>
        <label class="small">Afternoon On-time (HH:MM)</label><br>
        <input id="afternoon-on" placeholder="13:00" />
      </div>
      <div>
        <label class="small">Grace minutes</label><br>
        <input id="grace-min" placeholder="5" />
      </div>
      <button id="save-times" class="action-btn">Save Times</button>
    </div>
    <div style="font-size:12px;color:var(--muted)">Saved settings persist to Firebase (so all devices share them).</div>
  </div>

</section>

<section class="card" id="logs-card">
  <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
    <input id="logs-search" placeholder="Search name/course/year..." />
    <button id="export-btn" class="action-btn">üíæ Export</button>
    <button id="print-btn" class="action-btn">üñ®Ô∏è Print</button>
    <button id="reset-btn" class="action-btn reset-btn">üîÑ Reset Today</button>
  </div>

  <table id="logs-table" aria-live="polite">
    <thead>
      <tr>
        <th data-key="name">Name</th>
        <th data-key="course">Course / Year</th>
        <th data-key="timein">Time In</th>
        <th data-key="timeout">Time Out</th>
        <th data-key="date">Date</th>
        <th data-key="period">Period</th>
        <th data-key="status">Status</th>
      </tr>
    </thead>
    <tbody id="logs-body">
      <tr><td colspan="7" class="no-records">Loading...</td></tr>
    </tbody>
  </table>
</section>

  </main>  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, onValue, get, set, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
  apiKey: "AIzaSyC7h8wS3Rs6rSZVjUKL8DE9NlqxD3dCIgI",
  authDomain: "dent-dept-dtr.firebaseapp.com",
  databaseURL: "https://dent-dept-dtr-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dent-dept-dtr",
  storageBucket: "dent-dept-dtr.firebasestorage.app",
  messagingSenderId: "537868899036",
  appId: "1:537868899036:web:8dd6dfa10493533616da19",
  measurementId: "G-KD8DF5EDSW"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

  // Elements
  const videoEl = document.getElementById('video');
  const resultDiv = document.getElementById('result');
  const profileBox = document.getElementById('profile');
  const profileName = document.getElementById('profile-name');
  const profileEmail = document.getElementById('profile-email');
  const profileMode = document.getElementById('profile-mode');
  const profilePeriod = document.getElementById('profile-period');
  const profileStatus = document.getElementById('profile-status');

  const startBtn = document.getElementById('start-btn');
  const stopBtn = document.getElementById('stop-btn');
  const exportBtn = document.getElementById('export-btn');
  const printBtn = document.getElementById('print-btn');
  const resetBtn = document.getElementById('reset-btn');
  const logsSearch = document.getElementById('logs-search');
  const logsBody = document.getElementById('logs-body');

  const eventInput = document.getElementById('event-input');
  const saveEventBtn = document.getElementById('save-event');
  const morningOnInput = document.getElementById('morning-on');
  const afternoonOnInput = document.getElementById('afternoon-on');
  const graceMinInput = document.getElementById('grace-min');
  const saveTimesBtn = document.getElementById('save-times');

  const codeReader = new ZXing.BrowserQRCodeReader();

  let scanning = false;
  let scanCooldowns = {};
  let logsData = [];

  // Use Manila timezone for all timestamps
  function manilaNow(){
    // create a Date representing current time in Asia/Manila
    const now = new Date();
    const str = now.toLocaleString('en-US', { timeZone: 'Asia/Manila' });
    return new Date(str);
  }
  function pad(n){ return n < 10 ? '0' + n : n; }
  function todayYMD(d = manilaNow()){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
  function timeHMS(d = manilaNow()){ return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
  function timeHM(d = manilaNow()){ return `${pad(d.getHours())}:${pad(d.getMinutes())}`; }
  function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"]+/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]||m)); }

  // Clock (Manila)
  const clockElem = document.getElementById('clock');
  function updateClock(){ const now = manilaNow(); clockElem.textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`; }
  setInterval(updateClock, 1000); updateClock();

  function setResult(msg, status='info'){
    const icons = { success:'‚úÖ', error:'‚ùå', warning:'‚ö†Ô∏è', info:'‚ÑπÔ∏è' };
    resultDiv.textContent = `${icons[status]||''} ${msg}`;
    resultDiv.className = '';
    resultDiv.classList.add(`status-${status}`);
  }

  async function startScanner(){
    if (scanning) return;
    try {
      const devices = await codeReader.listVideoInputDevices();
      if (!devices || devices.length === 0) { setResult('No camera devices found.', 'error'); return; }
      const back = devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];
      scanning = true; setResult('Point camera to a QR code.', 'info');
      codeReader.decodeFromVideoDevice(back.deviceId, videoEl, (result, err) => {
        if (result && result.getText) handleScan(result.getText());
        else if (err && !(err instanceof ZXing.NotFoundException)) { console.error('ZXing error:', err); setResult('Camera error: ' + err.message, 'error'); }
      });
      startBtn.disabled = true; stopBtn.disabled = false;
    } catch(e){ console.error('startScanner', e); setResult('Camera error: ' + (e.message || e), 'error'); }
  }
  function stopScanner(){ try { codeReader.reset(); } catch(e){} scanning = false; setResult('Scanner stopped.', 'info'); startBtn.disabled = false; stopBtn.disabled = true; profileBox.style.display = 'none'; }

  // Settings persistence (Firebase)
  const settingsRef = ref(db, `settings/ci`);
  async function loadSettings(){
    const snap = await get(settingsRef);
    const s = snap.exists() ? snap.val() : {};
    eventInput.value = s.event || '';
    morningOnInput.value = s.morningOn || '08:00';
    afternoonOnInput.value = s.afternoonOn || '13:00';
    graceMinInput.value = s.graceMin != null ? s.graceMin : 5;
    return s;
  }
  saveEventBtn.addEventListener('click', async ()=>{
    const val = (eventInput.value || '').trim();
    await set(ref(db, `settings/ci/event`), val);
    setResult('Event saved.', 'success');
  });
  saveTimesBtn.addEventListener('click', async ()=>{
    const morning = (morningOnInput.value || '08:00').trim();
    const afternoon = (afternoonOnInput.value || '13:00').trim();
    const grace = parseInt(graceMinInput.value || '5');
    await set(ref(db, `settings/ci/times`), { morningOn: morning, afternoonOn: afternoon, graceMin: isNaN(grace)?5:grace });
    setResult('Time settings saved.', 'success');
  });

  // helper to compare times (HH:MM)
  function isOnTime(scanHM, onTimeHM, graceMin){
    const [sh,sm] = scanHM.split(':').map(Number);
    const [oh,om] = onTimeHM.split(':').map(Number);
    const scanMinutes = sh*60 + sm;
    const onMinutes = oh*60 + om;
    return scanMinutes <= (onMinutes + (graceMin||0));
  }

  // Determine morning/afternoon period
  function periodForDate(d = manilaNow()){
    return d.getHours() < 12 ? 'Morning' : 'Afternoon';
  }

  async function handleScan(text){
    if (!scanning) return;
    const raw = String(text || '').trim(); if (!raw) return;
    const nowMs = Date.now(); if (scanCooldowns[raw] && (nowMs - scanCooldowns[raw] < 3000)) return; scanCooldowns[raw] = nowMs;

    const parts = raw.split('|');
    if(parts.length !== 2) { setResult('Invalid QR format. Expected "UID|MODE".', 'error'); profileBox.style.display = 'none'; return; }
    const uid = parts[0].trim(); const mode = parts[1].trim().toUpperCase();
    if (!uid || (mode !== 'IN' && mode !== 'OUT')) { setResult('Invalid UID or Mode in QR code.', 'error'); profileBox.style.display = 'none'; return; }

    setResult(`Processing UID: ${uid} Mode: ${mode}`, 'info'); profileBox.style.display = 'none';

    const dateStr = todayYMD(); const timeStr = timeHMS(); const hm = timeHM(); const period = periodForDate();

    try{
      const profSnap = await get(ref(db, `users/${uid}/profile`));
      if (!profSnap.exists()){ setResult(`UID ${uid} not registered.`, 'error'); return; }
      const profile = profSnap.val();

      // load settings to evaluate on-time
      const sSnap = await get(ref(db, `settings/ci/times`));
      const s = sSnap.exists() ? sSnap.val() : { morningOn:'08:00', afternoonOn:'13:00', graceMin:5 };
      const onTimeHM = period === 'Morning' ? (s.morningOn||'08:00') : (s.afternoonOn||'13:00');
      const grace = s.graceMin != null ? s.graceMin : 5;
      const statusIn = isOnTime(hm, onTimeHM, grace) ? 'On Time' : 'Late';

      const dtrRef = ref(db, `users/${uid}/dtr/${dateStr}/${period.toLowerCase()}`);
      const dtrSnap = await get(dtrRef);
      const dtrData = dtrSnap.exists() ? dtrSnap.val() : {};

      // Structure: dtr/{date}/{period} => { timeIn, tsIn, timeInStatus, timeOut, tsOut }
      if (mode === 'IN'){
        if (dtrData.timeIn){ setResult(`User ${profile.name} already TIME IN for ${period} at ${dtrData.timeIn}`, 'warning'); return; }
        await set(dtrRef, { ...dtrData, timeIn: timeStr, tsIn: Date.now(), timeInStatus: statusIn });
        // also write index lists for easier view
        await set(ref(db, `timeIns/${dateStr}/${uid}_${period}`), { uid, name: profile.name||'', email: profile.email||'', course: profile.course||'', year: profile.year||'', date: dateStr, time: timeStr, ts: Date.now(), period, status: statusIn });
        setResult(`Recorded TIME IN (${period}) for ${profile.name} at ${timeStr} ‚Äî ${statusIn}`, 'success');
        document.getElementById('success-sound').play();
      } else if (mode === 'OUT'){
        if (!dtrData.timeIn){ setResult(`User ${profile.name} has not timed IN yet for ${period}. Cannot TIME OUT.`, 'error'); return; }
        if (dtrData.timeOut){ setResult(`User ${profile.name} already TIME OUT for ${period} at ${dtrData.timeOut}`, 'warning'); return; }
        await set(dtrRef, { ...dtrData, timeOut: timeStr, tsOut: Date.now() });
        await set(ref(db, `timeOuts/${dateStr}/${uid}_${period}`), { uid, name: profile.name||'', email: profile.email||'', course: profile.course||'', year: profile.year||'', date: dateStr, time: timeStr, ts: Date.now(), period });
        setResult(`Recorded TIME OUT (${period}) for ${profile.name} at ${timeStr}`, 'success');
        document.getElementById('success-sound').play();
      }

      // show profile box for quick feedback
      profileName.textContent = profile.name || '';
      profileEmail.textContent = profile.email || '';
      profileMode.textContent = mode;
      profilePeriod.textContent = period;
      profileStatus.textContent = mode === 'IN' ? statusIn : (dtrData.timeInStatus || '‚Äî');
      profileBox.style.display = 'block';

    } catch(err){ console.error('Error saving DTR:', err); setResult('Error saving time record: ' + (err.message || err), 'error'); profileBox.style.display = 'none'; }
  }

  function renderLogs(filterText=''){
    const ft = (filterText||'').toLowerCase();
    const filtered = logsData.filter(e => {
      return (e.name||'').toLowerCase().includes(ft) || (e.course||'').toLowerCase().includes(ft) || (e.year||'').toLowerCase().includes(ft) || (e.date||'').toLowerCase().includes(ft) || (e.period||'').toLowerCase().includes(ft);
    });
    if (filtered.length === 0){ logsBody.innerHTML = '<tr><td colspan="7" class="no-records">No records</td></tr>'; return; }
    logsBody.innerHTML = filtered.map(entry => {
      const courseYear = `${escapeHtml(entry.course||'')} ${entry.year?('/ '+escapeHtml(entry.year)) : ''}`;
      const tine = escapeHtml(entry.timeIn||'‚Äî');
      const tout = escapeHtml(entry.timeOut||'‚Äî');
      return `<tr>
        <td>${escapeHtml(entry.name)}</td>
        <td>${courseYear}</td>
        <td>${tine}</td>
        <td>${tout}</td>
        <td>${escapeHtml(entry.date)}</td>
        <td>${escapeHtml(entry.period)}</td>
        <td>${escapeHtml(entry.timeInStatus||'')}</td>
      </tr>`;
    }).join('');
  }

  function flattenLogs(insObj, outsObj){
    // insObj and outsObj keyed by uid_period (uid_Morning or uid_Afternoon)
    const rows = [];
    const keys = new Set([...Object.keys(insObj||{}), ...Object.keys(outsObj||{})]);
    keys.forEach(k => {
      const inEntry = insObj && insObj[k] ? insObj[k] : null;
      const outEntry = outsObj && outsObj[k] ? outsObj[k] : null;
      const uidPeriod = k.split('_');
      const uid = uidPeriod[0];
      const period = uidPeriod[1] || '';
      rows.push({
        name: inEntry?.name || outEntry?.name || '',
        course: inEntry?.course || outEntry?.course || '',
        year: inEntry?.year || outEntry?.year || '',
        timeIn: inEntry?.time || (inEntry?.time) || (''),
        timeOut: outEntry?.time || (outEntry?.time) || (''),
        date: inEntry?.date || outEntry?.date || todayYMD(),
        period: period,
        timeInStatus: inEntry?.status || ''
      });
    });
    // sort by ts (descending by default)
    rows.sort((a,b) => 0);
    return rows;
  }

  async function listenLogs(){
    const dateStr = todayYMD();
    const insRef = ref(db, `timeIns/${dateStr}`);
    const outsRef = ref(db, `timeOuts/${dateStr}`);
    function update(){
      Promise.all([get(insRef), get(outsRef)]).then(([inSnap, outSnap]) => {
        const ins = inSnap.exists() ? inSnap.val() : {};
        const outs = outSnap.exists() ? outSnap.val() : {};
        logsData = flattenLogs(ins, outs);
        renderLogs(logsSearch.value || '');
      }).catch(err=>{ console.error('update logs',err); });
    }
    onValue(insRef, update);
    onValue(outsRef, update);
    update();
  }

  function exportCSV(){
    if (!logsData || logsData.length === 0) { alert('No data to export'); return; }
    const headers = ['Name','Course','Year','Time In','Time Out','Date','Period','Status'];
    const rows = logsData.map(r => [r.name, r.course, r.year, r.timeIn, r.timeOut, r.date, r.period, r.timeInStatus || '']);
    let csv = headers.join(',') + '\r\n';
    rows.forEach(cols => { csv += cols.map(c => '"' + String(c||'').replace(/"/g,'""') + '"').join(',') + '\r\n'; });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `dtr_logs_${todayYMD()}.csv`; document.body.appendChild(a); a.click(); a.remove();
  }
  exportBtn.addEventListener('click', exportCSV);

  function printLogs(){
    const html = `<html><head><title>DTR Logs ${todayYMD()}</title><style>body{font-family:Arial;color:#111}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ccc;padding:6px;text-align:left}th{background:#eee}</style></head><body><h2>DTR Logs ${todayYMD()}</h2><table><thead><tr><th>Name</th><th>Course</th><th>Year</th><th>Time In</th><th>Time Out</th><th>Period</th><th>Status</th></tr></thead><tbody>` + logsData.map(r => `<tr><td>${escapeHtml(r.name)}</td><td>${escapeHtml(r.course)}</td><td>${escapeHtml(r.year)}</td><td>${escapeHtml(r.timeIn)}</td><td>${escapeHtml(r.timeOut)}</td><td>${escapeHtml(r.period)}</td><td>${escapeHtml(r.timeInStatus||'')}</td></tr>`).join('') + `</tbody></table></body></html>`;
    const w = window.open('', '_blank', 'width=900,height=700'); w.document.write(html); w.document.close(); w.focus(); w.print();
  }
  printBtn.addEventListener('click', printLogs);

  async function resetToday(){ if (!confirm('Archive today\'s logs and clear live results?')) return; const dateStr = todayYMD(); const timeInsRef = ref(db, `timeIns/${dateStr}`); const timeOutsRef = ref(db, `timeOuts/${dateStr}`); const archiveRef = ref(db, `archives/${dateStr}`); try{ const [insSnap, outsSnap] = await Promise.all([get(timeInsRef), get(timeOutsRef)]); const data = { timeIns: insSnap.exists() ? insSnap.val() : {}, timeOuts: outsSnap.exists() ? outsSnap.val() : {} }; if (Object.keys(data.timeIns).length === 0 && Object.keys(data.timeOuts).length === 0) { alert('No logs to archive for today.'); return; } await set(archiveRef, data); await Promise.all([remove(timeInsRef), remove(timeOutsRef)]); setResult('Archived and cleared today\'s logs.', 'success'); } catch(err){ console.error('resetToday', err); setResult('Failed to reset: ' + (err.message || err), 'error'); } }
  resetBtn.addEventListener('click', resetToday);

  // Start everything
  startBtn.addEventListener('click', startScanner);
  stopBtn.addEventListener('click', stopScanner);
  logsSearch.addEventListener('input', e => renderLogs(e.target.value || ''));
  listenLogs(); loadSettings();

  </script>

  <audio id="success-sound" src="Thank you.mp3" preload="auto"></audio>
</body>
</html>
