<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Attendance Admin Panel</title>

<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>

<style>
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:#f4f4f4;
}

#topbar{
  background:#fff;
  border-bottom:3px solid #7b38c3;
  padding:12px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

#logo{height:42px}

#container{
  max-width:1200px;
  margin:20px auto;
  display:flex;
  gap:16px;
}

.card{
  background:#fff;
  padding:16px;
  border:1px solid #ccc;
  border-radius:6px;
}

.left{width:340px}
.right{flex:1}

button{
  padding:10px;
  border:none;
  background:#7b38c3;
  color:#fff;
  border-radius:4px;
  cursor:pointer;
}
button.ghost{
  background:#fff;
  color:#7b38c3;
  border:1px solid #7b38c3;
}

.controls{
  display:flex;
  gap:8px;
  margin-top:10px;
  flex-wrap:wrap;
}

video{
  width:100%;
  height:240px;
  background:#000;
  margin-top:10px;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}

th,td{
  border:1px solid #000;
  padding:6px;
}

th{background:#eee}

#toast{
  position:fixed;
  top:20px;
  right:20px;
  background:#333;
  color:#fff;
  padding:10px 14px;
  display:none;
  z-index:999;
}

#loginScreen{
  position:fixed;
  inset:0;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#eee;
}

.print-header{
  display:none;
}

/* PRINT */
@media print{
  body{background:#fff}
  #topbar,.left,#toast,button,input,select{display:none!important}
  .print-header{display:block;text-align:center;margin-bottom:20px}
  th{background:#ddd!important}
}
</style>
</head>

<body>

<div id="toast"></div>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="card">
    <h3>Admin Login</h3>
    <input id="loginUser" placeholder="Username"><br><br>
    <input id="loginPass" type="password" placeholder="Password"><br><br>
    <button id="loginBtn">Login</button>
    <div id="loginError" style="color:red;display:none">Invalid credentials</div>
  </div>
</div>

<div id="adminApp" style="display:none">

<header id="topbar">
  <div style="display:flex;align-items:center;gap:10px">
    <img id="logo" src="college-logo.png">
    <strong>Attendance Admin</strong>
  </div>
  <button id="logoutBtn" class="ghost">Logout</button>
</header>

<main id="container">

<section class="left card">
  <h4>QR Scanner</h4>

  <select id="session">
    <option value="morning">Morning</option>
    <option value="afternoon">Afternoon</option>
  </select>

  <div class="controls">
    <button id="startBtn">Start</button>
    <button id="stopBtn" class="ghost" disabled>Stop</button>
    <button id="resetBtn" class="ghost">Reset Today</button>
  </div>

  <video id="video" autoplay muted></video>

  <div class="controls">
    <button id="printBtn">Print</button>
  </div>
</section>

<section class="right card">

  <div class="print-header">
    <h2>Daily Attendance Report</h2>
    <p id="printDate"></p>
  </div>

  <table>
    <thead>
      <tr>
        <th>Name</th><th>Course</th><th>Year</th>
        <th>Morning In</th><th>Morning Out</th>
        <th>Afternoon In</th><th>Afternoon Out</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

</section>

</main>
  </div>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, get, set, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ===== CONFIG ===== */
const LOGIN_USER="admin";
const LOGIN_PASS="admin123";
const AUTO_LOGOUT_MS=5*60*1000;

/* ===== ELEMENTS ===== */
const el=id=>document.getElementById(id);
const toast=el("toast");
const loginScreen=el("loginScreen");
const adminApp=el("adminApp");

/* ===== TOAST ===== */
function showToast(msg){
  toast.textContent=msg;
  toast.style.display="block";
  setTimeout(()=>toast.style.display="none",2500);
}

/* ===== LOGIN ===== */
let logoutTimer;
function resetTimer(){
  clearTimeout(logoutTimer);
  logoutTimer=setTimeout(()=>logout(),AUTO_LOGOUT_MS);
}
["click","mousemove","keydown","touchstart"].forEach(e=>{
  document.addEventListener(e,()=>sessionStorage.getItem("admin")&&resetTimer(),{passive:true});
});

el("loginBtn").onclick=()=>{
  if(el("loginUser").value===LOGIN_USER && el("loginPass").value===LOGIN_PASS){
    sessionStorage.setItem("admin","1");
    loginScreen.style.display="none";
    adminApp.style.display="block";
    resetTimer();
  }else el("loginError").style.display="block";
};

function logout(){
  sessionStorage.clear();
  stopScanner();
  location.reload();
}
el("logoutBtn").onclick=logout;

if(sessionStorage.getItem("admin")==="1"){
  loginScreen.style.display="none";
  adminApp.style.display="block";
  resetTimer();
}

/* ===== FIREBASE ===== */
const app=initializeApp({
  apiKey:"AIzaSyC7h8wS3Rs6rSZVjUKL8DE9NlqxD3dCIgI",
  databaseURL:"https://dent-dept-dtr-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db=getDatabase(app);

/* ===== DATE ===== */
const today=new Date().toISOString().slice(0,10);
el("printDate").textContent=`Date: ${today}`;
const ADMIN_PATH=`adminAttendance/${today}`;

/* ===== SCANNER ===== */
const reader=new ZXing.BrowserQRCodeReader();
let scanning=false;
let lastScan={uid:null,ts:0};

async function startScanner(){
  if(scanning) return;
  const cams=await reader.listVideoInputDevices();
  const cam=cams.find(c=>/rear|back|env/i.test(c.label))||cams[0];
  reader.decodeFromVideoDevice(cam.deviceId,el("video"),res=>{
    if(res) handleScan(res.getText());
  });
  scanning=true;
}
function stopScanner(){
  reader.reset();
  scanning=false;
}
el("startBtn").onclick=startScanner;
el("stopBtn").onclick=stopScanner;

/* ===== DATA ===== */
let store={};
onValue(ref(db,ADMIN_PATH),s=>{
  store=s.exists()?s.val():{};
  render();
});

/* ===== SCAN LOGIC ===== */
async function handleScan(txt){
  let qr;
  try{qr=JSON.parse(txt);}catch{return;}

  const now=Date.now();
  if(qr.uid===lastScan.uid && now-lastScan.ts<2000) return;
  lastScan={uid:qr.uid,ts:now};

  const userSnap=await get(ref(db,`users/${qr.uid}`));
  if(!userSnap.exists()){showToast("Student not found");return;}

  const row=store[qr.uid]||{};
  const sess=el("session").value;
  const inK=sess==="morning"?"morningIn":"afternoonIn";
  const outK=sess==="morning"?"morningOut":"afternoonOut";

  if(qr.mode==="out" && !row[inK]){showToast("Time-In required");return;}
  const key=qr.mode==="in"?inK:outK;
  if(row[key]){showToast("Already recorded");return;}

  await set(ref(db,`${ADMIN_PATH}/${qr.uid}`),{
    ...row,
    ...userSnap.val(),
    [key]:now
  });

  showToast("Recorded");
}

/* ===== RENDER ===== */
function fmt(t){return t?new Date(t).toLocaleTimeString():'';}
function render(){
  el("tableBody").innerHTML=Object.values(store).map(r=>`
    <tr>
      <td>${r.name}</td><td>${r.course}</td><td>${r.year}</td>
      <td>${fmt(r.morningIn)}</td><td>${fmt(r.morningOut)}</td>
      <td>${fmt(r.afternoonIn)}</td><td>${fmt(r.afternoonOut)}</td>
    </tr>`).join("");
}

/* ===== RESET (SAFE) ===== */
el("resetBtn").onclick=async()=>{
  const pass=prompt("Enter admin password:");
  if(pass!==LOGIN_PASS){showToast("Wrong password");return;}

  // CSV BACKUP
  let csv="Name,Course,Year,Morning In,Morning Out,Afternoon In,Afternoon Out\n";
  Object.values(store).forEach(r=>{
    csv+=`${r.name},${r.course},${r.year},${fmt(r.morningIn)},${fmt(r.morningOut)},${fmt(r.afternoonIn)},${fmt(r.afternoonOut)}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`attendance_${today}.csv`;
  a.click();

  if(!confirm("Reset ADMIN records for today?")) return;
  await remove(ref(db,ADMIN_PATH));
  showToast("Admin records reset");
};

el("printBtn").onclick=()=>window.print();
</script>

</body>
      </html>
