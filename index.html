<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Attendance Panel</title>

<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:linear-gradient(135deg,#fff,#ffe6f0);
  -webkit-text-size-adjust:100%;
}

.card{
  background:#fff;
  padding:14px;
  border-radius:14px;
  box-shadow:0 8px 20px rgba(0,0,0,.12);
}

button{
  padding:14px;
  border:none;
  border-radius:14px;
  background:#7b38c3;
  color:#fff;
  font-weight:600;
  font-size:15px;
  cursor:pointer;
}

button.ghost{
  background:#fff;
  color:#7b38c3;
  border:1px solid #ccc;
}

input,select{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid #ccc;
  font-size:15px;
}

#video{
  width:100%;
  height:260px;
  background:#000;
  border-radius:14px;
  object-fit:cover;
}

table{
  width:100%;
  border-collapse:collapse;
  min-width:720px;
}

th,td{
  padding:12px;
  border-bottom:1px solid #eee;
  white-space:nowrap;
}

thead th{
  position:sticky;
  top:0;
  background:#fff;
  z-index:2;
}

#toast{
  position:fixed;
  top:16px;
  right:16px;
  padding:12px 16px;
  border-radius:12px;
  color:#fff;
  display:none;
  z-index:999;
}

#toast.success{background:#2ecc71}
#toast.error{background:#e74c3c}

/* Web header */
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  margin-bottom:8px;
}

.brand{
  display:flex;
  align-items:center;
  gap:10px;
}

.web-logo{
  width:42px;
  height:42px;
  object-fit:contain;
  border-radius:8px;
}

/* Mobile */
@media (max-width:900px){
  body{padding-bottom:70px}
  .mobile-stack{display:flex;flex-direction:column;gap:14px}
  .scanner-sticky{position:sticky;top:0;z-index:10}
  .table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
}

/* PRINT */
@media print{
  body *{visibility:hidden}
  .print-area,.print-area *{visibility:visible}
  .print-area{position:absolute;left:0;top:0;width:100%}
  button,input,select,video,#toast,#loginScreen{display:none!important}
  body{background:#fff}

  .print-header{
    display:flex;
    justify-content:space-between;
    border-bottom:2px solid #000;
    padding-bottom:8px;
    margin-bottom:10px;
  }

  .print-logo{width:80px}

  table{font-size:12px}
  th,td{border:1px solid #000;padding:6px}
  thead{display:table-header-group}
  tr{page-break-inside:avoid}
}
</style>
</head>

<body>

<div id="toast"></div>

<!-- LOGIN -->
<div id="loginScreen" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center">
  <div class="card" style="width:320px">
    <h2>Admin Login</h2>
    <input id="loginUser" placeholder="Username">
    <input id="loginPass" type="password" placeholder="Password" style="margin-top:8px">
    <button id="loginBtn" style="width:100%;margin-top:10px">Login</button>
    <div id="loginError" style="display:none;color:red;margin-top:8px">Invalid credentials</div>
  </div>
</div>

<div id="adminApp" style="display:none;padding:16px">

<div class="topbar">
  <div class="brand">
    <img src="college-logo.png" class="web-logo">
    <h2>Attendance Admin</h2>
  </div>
  <button id="logoutBtn" class="ghost">Logout</button>
</div>

<div>Today: <strong id="todayLabel"></strong></div>

<div class="mobile-stack" style="display:grid;grid-template-columns:320px 1fr;gap:16px;margin-top:16px">

<!-- LEFT -->
<div class="card scanner-sticky">
  <h3>QR Scanner</h3>
  <select id="session">
    <option value="morning">Morning</option>
    <option value="afternoon">Afternoon</option>
  </select>

  <div style="display:flex;gap:8px;margin:8px 0">
    <button id="startBtn">Start</button>
    <button id="stopBtn" class="ghost" disabled>Stop</button>
  </div>

  <video id="video" autoplay muted playsinline></video>

  <div style="display:flex;gap:8px;margin-top:8px">
    <button id="exportBtn">Save CSV</button>
    <button id="printBtn" class="ghost">Print</button>
  </div>
</div>

<!-- RIGHT -->
<div class="card print-area">
  <div class="print-header">
    <div>
      <h2>YOUR SCHOOL NAME</h2>
      <div>Attendance Report</div>
      <div>
        Date: <strong id="printDate"></strong><br>
        Session: <strong id="printSession"></strong>
      </div>
    </div>
    <img src="college-logo.png" class="print-logo">
  </div>

  <div style="display:flex;gap:8px;margin-bottom:8px">
    <input id="search" placeholder="Search...">
    <button id="resetBtn" class="ghost">Reset</button>
  </div>

  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>Name</th><th>Course</th><th>Year</th>
          <th>M In</th><th>M Out</th>
          <th>A In</th><th>A Out</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div style="margin-top:8px">
    Shown: <strong id="countShown">0</strong> |
    Total: <strong id="totalCount">0</strong>
  </div>
</div>

</div>
</div>

  
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const $=id=>document.getElementById(id);
const loginBtn=$("loginBtn"),loginUser=$("loginUser"),loginPass=$("loginPass"),loginError=$("loginError");
const loginScreen=$("loginScreen"),adminApp=$("adminApp"),logoutBtn=$("logoutBtn");
const startBtn=$("startBtn"),stopBtn=$("stopBtn"),video=$("video");
const sessionSelect=$("session"),tableBody=$("tableBody"),searchEl=$("search");
const resetBtn=$("resetBtn"),todayLabel=$("todayLabel"),countShown=$("countShown"),totalCount=$("totalCount");
const exportBtn=$("exportBtn"),printBtn=$("printBtn"),toast=$("toast");

function showToast(msg,type="success"){
  toast.textContent=msg;
  toast.className=type;
  toast.style.display="block";
  setTimeout(()=>toast.style.display="none",2000);
}

/* LOGIN */
loginBtn.onclick=()=>{
  if(loginUser.value==="admin"&&loginPass.value==="admin123"){
    sessionStorage.setItem("admin","1");
    showApp();
  }else loginError.style.display="block";
};
logoutBtn.onclick=()=>{sessionStorage.clear();location.reload()};
function showApp(){
  loginScreen.style.display="none";
  adminApp.style.display="block";
}
if(sessionStorage.getItem("admin")==="1") showApp();

/* AUTO LOGOUT */
let timer;
function resetTimer(){
  clearTimeout(timer);
  timer=setTimeout(()=>{showToast("Logged out","error");logoutBtn.onclick()},5*60*1000);
}
["click","mousemove","keydown","touchstart"].forEach(e=>{
  document.addEventListener(e,()=>sessionStorage.getItem("admin")&&resetTimer());
});

/* FIREBASE */
const app=initializeApp({
  apiKey:"AIzaSyC7h8wS3Rs6rSZVjUKL8DE9NlqxD3dCIgI",
  databaseURL:"https://dent-dept-dtr-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db=getDatabase(app);

/* DATE */
const today=new Date().toISOString().slice(0,10);
todayLabel.textContent=today;

/* DATA */
let tableData={};
onValue(ref(db,"attendance/"+today),snap=>{
  tableData=snap.val()||{};
  render();
});

/* QR */
const reader=new ZXing.BrowserQRCodeReader();
let last="";
startBtn.onclick=async()=>{
  const d=await reader.listVideoInputDevices();
  const cam=d.find(x=>/back|rear/i.test(x.label))||d[0];
  reader.decodeFromVideoDevice(cam.deviceId,video,res=>{
    if(res&&res.getText()!==last){
      last=res.getText();
      handleScan(last);
    }
  });
  startBtn.disabled=true;stopBtn.disabled=false;
};
stopBtn.onclick=()=>{reader.reset();startBtn.disabled=false;stopBtn.disabled=true};

function parseQR(t){try{const j=JSON.parse(t);return j.uid&&j.mode?j:null}catch{return null}}

async function handleScan(t){
  const qr=parseQR(t);
  if(!qr)return showToast("Invalid QR","error");

  const uref=ref(db,`attendance/${today}/${qr.uid}`);
  const snap=await get(uref);
  const data=snap.val()||{};
  const profSnap=await get(ref(db,`users/${qr.uid}`));
  const prof=profSnap.val()||{};
  const now=Date.now(),s=sessionSelect.value;

  if(qr.mode==="in"){
    if(s==="morning"&&!data.morningIn)data.morningIn=now;
    if(s==="afternoon"&&!data.afternoonIn)data.afternoonIn=now;
  }
  if(qr.mode==="out"){
    if(s==="morning"&&data.morningIn&&!data.morningOut)data.morningOut=now;
    if(s==="afternoon"&&data.afternoonIn&&!data.afternoonOut)data.afternoonOut=now;
  }
  Object.assign(data,{name:prof.name||"",course:prof.course||"",year:prof.year||"",date:today});
  await set(uref,data);
  showToast("Recorded");
}

/* TABLE */
function f(t){return t?new Date(t).toLocaleTimeString():""}
function render(){
  tableBody.innerHTML="";
  let shown=0;
  Object.values(tableData).forEach(r=>{
    const h=`${r.name} ${r.course} ${r.year}`.toLowerCase();
    if(searchEl.value&&!h.includes(searchEl.value.toLowerCase()))return;
    tableBody.innerHTML+=`
      <tr>
        <td>${r.name}</td><td>${r.course}</td><td>${r.year}</td>
        <td>${f(r.morningIn)}</td><td>${f(r.morningOut)}</td>
        <td>${f(r.afternoonIn)}</td><td>${f(r.afternoonOut)}</td>
      </tr>`;
    shown++;
  });
  countShown.textContent=shown;
  totalCount.textContent=Object.keys(tableData).length;
}
searchEl.oninput=render;
resetBtn.onclick=()=>{searchEl.value="";render()};

/* CSV */
exportBtn.onclick=()=>{
  let csv="Name,Course,Year,M In,M Out,A In,A Out\n";
  Object.values(tableData).forEach(r=>{
    csv+=`${r.name},${r.course},${r.year},${f(r.morningIn)},${f(r.morningOut)},${f(r.afternoonIn)},${f(r.afternoonOut)}\n`;
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download=`attendance_${today}.csv`;
  a.click();
};

/* PRINT */
printBtn.onclick=()=>{
  $("printDate").textContent=today;
  $("printSession").textContent=sessionSelect.value.toUpperCase();
  window.print();
};
</script>

</body>
</html>
