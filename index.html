<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Attendance Panel</title>

<!-- ZXing -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>

<style>
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:linear-gradient(135deg,#fff,#ffe6f0);
}
.card{
  background:#fff;
  border-radius:12px;
  padding:16px;
  box-shadow:0 8px 24px rgba(0,0,0,.1);
}
button{
  padding:10px 14px;
  border:none;
  border-radius:10px;
  background:#7b38c3;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
button.ghost{
  background:#fff;
  color:#7b38c3;
  border:1px solid #ccc;
}
#video{
  width:100%;
  height:240px;
  background:#000;
  border-radius:10px;
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  border-bottom:1px solid #ddd;
}
#toast{
  position:fixed;
  top:20px;
  right:20px;
  background:#333;
  color:#fff;
  padding:10px 14px;
  border-radius:8px;
  display:none;
}
</style>
</head>

<body>

<div id="toast"></div>

<!-- LOGIN -->
<div id="loginScreen" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;">
  <div class="card" style="width:320px;">
    <h2>Admin Login</h2>
    <input id="loginUser" placeholder="Username" style="width:100%;margin-bottom:8px">
    <input id="loginPass" type="password" placeholder="Password" style="width:100%">
    <button id="loginBtn" style="width:100%;margin-top:10px">Login</button>
    <div id="loginError" style="color:red;display:none;margin-top:8px">Invalid login</div>
  </div>
</div>

<!-- APP -->
<div id="adminApp" style="display:none;padding:16px">

<div style="display:flex;justify-content:space-between;align-items:center">
  <h2>Attendance Admin</h2>
  <button id="logoutBtn" class="ghost">Logout</button>
</div>

<div style="display:grid;grid-template-columns:320px 1fr;gap:16px;margin-top:16px">

<!-- LEFT -->
<div class="card">
  <h3>QR Scanner</h3>

  <select id="session" style="width:100%;margin-bottom:8px">
    <option value="morning">Morning</option>
    <option value="afternoon">Afternoon</option>
  </select>

  <button id="startBtn">Start Scan</button>
  <button id="stopBtn" class="ghost" disabled>Stop</button>

  <video id="video" autoplay muted playsinline></video>
</div>

<!-- RIGHT -->
<div class="card">
  <input id="search" placeholder="Search..." style="width:100%;margin-bottom:10px">

  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Course</th>
        <th>Year</th>
        <th>M In</th>
        <th>M Out</th>
        <th>A In</th>
        <th>A Out</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ELEMENTS */
const loginBtn = document.getElementById("loginBtn");
const loginUser = document.getElementById("loginUser");
const loginPass = document.getElementById("loginPass");
const loginError = document.getElementById("loginError");
const loginScreen = document.getElementById("loginScreen");
const adminApp = document.getElementById("adminApp");
const logoutBtn = document.getElementById("logoutBtn");

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const video = document.getElementById("video");
const sessionSelect = document.getElementById("session");
const tableBody = document.getElementById("tableBody");
const searchEl = document.getElementById("search");
const toast = document.getElementById("toast");

/* TOAST */
function showToast(msg){
  toast.textContent = msg;
  toast.style.display = "block";
  setTimeout(()=>toast.style.display="none",2000);
}

/* LOGIN */
loginBtn.onclick = () => {
  if(loginUser.value==="admin" && loginPass.value==="admin123"){
    sessionStorage.setItem("admin","1");
    showApp();
  }else{
    loginError.style.display="block";
  }
};
logoutBtn.onclick = () => {
  sessionStorage.removeItem("admin");
  location.reload();
};
function showApp(){
  loginScreen.style.display="none";
  adminApp.style.display="block";
}
if(sessionStorage.getItem("admin")==="1") showApp();

/* FIREBASE */
const app = initializeApp({
  apiKey:"AIzaSyC7h8wS3Rs6rSZVjUKL8DE9NlqxD3dCIgI",
  databaseURL:"https://dent-dept-dtr-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db = getDatabase(app);

const today = new Date().toISOString().slice(0,10);
let tableData = {};

onValue(ref(db,"attendance/"+today), snap=>{
  tableData = snap.val() || {};
  render();
});

/* QR */
const reader = new ZXing.BrowserQRCodeReader();
let last = "";

startBtn.onclick = async () => {
  const devices = await reader.listVideoInputDevices();
  reader.decodeFromVideoDevice(devices[0].deviceId, video, (res)=>{
    if(res){
      const txt = res.getText();
      if(txt===last) return;
      last = txt;
      handleScan(txt);
    }
  });
  startBtn.disabled=true;
  stopBtn.disabled=false;
};

stopBtn.onclick = ()=>{
  reader.reset();
  startBtn.disabled=false;
  stopBtn.disabled=true;
};

function parseQR(txt){
  try{
    const j = JSON.parse(txt);
    if(j.uid && j.mode) return j;
  }catch{}
  return null;
}

async function handleScan(txt){
  const qr = parseQR(txt);
  if(!qr){showToast("Invalid QR");return;}

  const refUser = ref(db,`attendance/${today}/${qr.uid}`);
  const snap = await get(refUser);
  const data = snap.val() || {};
  const sess = sessionSelect.value;
  const now = Date.now();

  if(qr.mode==="in"){
    if(sess==="morning" && !data.morningIn) data.morningIn=now;
    if(sess==="afternoon" && !data.afternoonIn) data.afternoonIn=now;
  }
  if(qr.mode==="out"){
    if(sess==="morning" && data.morningIn && !data.morningOut) data.morningOut=now;
    if(sess==="afternoon" && data.afternoonIn && !data.afternoonOut) data.afternoonOut=now;
  }
  data.date=today;
  await set(refUser,data);
  showToast("Recorded");
}

function t(v){
  if(!v) return "";
  const d=new Date(v);
  return d.toLocaleTimeString();
}

function render(){
  tableBody.innerHTML="";
  Object.values(tableData).forEach(r=>{
    const h = `${r.name||""} ${r.course||""} ${r.year||""}`.toLowerCase();
    if(searchEl.value && !h.includes(searchEl.value.toLowerCase())) return;
    tableBody.innerHTML+=`
      <tr>
        <td>${r.name||""}</td>
        <td>${r.course||""}</td>
        <td>${r.year||""}</td>
        <td>${t(r.morningIn)}</td>
        <td>${t(r.morningOut)}</td>
        <td>${t(r.afternoonIn)}</td>
        <td>${t(r.afternoonOut)}</td>
      </tr>`;
  });
}
searchEl.oninput=render;
</script>

</body>
</html>
