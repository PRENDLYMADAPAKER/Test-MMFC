<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Admin Attendance Panel</title>

<!-- ZXing QR -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>

<style>
:root{
  --bg1:#ffffff;
  --bg2:#ffe6f0;
  --accent1:#b76bdc;
  --accent2:#7b38c3;
  --muted:#666;
  --shadow:0 10px 30px rgba(59,20,88,0.08);
  --radius:14px;
  --maxw:1200px;
}
html,body{
  margin:0;height:100%;
  font-family:Inter,Arial,sans-serif;
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
}
#topbar{
  max-width:var(--maxw);
  margin:0 auto 16px;
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-radius:var(--radius);
  background:rgba(255,255,255,.55);
  backdrop-filter:blur(6px);
  box-shadow:var(--shadow);
}
#logo{width:52px;height:52px;object-fit:contain;border-radius:10px}
#container{
  max-width:var(--maxw);
  margin:0 auto;
  display:flex;
  gap:18px;
}
.card{
  border-radius:var(--radius);
  background:rgba(255,255,255,.6);
  backdrop-filter:blur(9px);
  padding:16px;
  box-shadow:var(--shadow);
}
@media(max-width:820px){
  #container{flex-direction:column;align-items:center}
  .left,.right{width:100%;max-width:500px}
}
.left{flex:0 0 360px}
.right{flex:1;display:flex;flex-direction:column}
label{font-size:13px;color:var(--muted)}
input,select{
  width:100%;
  padding:11px;
  border-radius:10px;
  border:1px solid rgba(0,0,0,.1);
}
button{
  padding:12px;
  border-radius:12px;
  border:none;
  cursor:pointer;
  font-weight:600;
  background:linear-gradient(90deg,var(--accent1),var(--accent2));
  color:#fff;
}
button.ghost{
  background:#fff;
  color:var(--accent2);
  border:1px solid rgba(0,0,0,.15);
}
.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
#video{
  width:100%;
  height:260px;
  background:#000;
  border-radius:12px;
  margin-top:10px;
}
.table-wrap{
  overflow:auto;
  border-radius:12px;
  border:1px solid rgba(0,0,0,.08);
}
table{
  width:100%;
  border-collapse:collapse;
  min-width:700px;
}
th,td{
  padding:12px;
  border-bottom:1px solid rgba(0,0,0,.05);
}
thead th{
  position:sticky;
  top:0;
  background:rgba(255,255,255,.9);
}
#summaryBar{
  margin-top:14px;
  padding:12px;
  border-radius:12px;
  background:rgba(255,255,255,.55);
  display:flex;
  justify-content:space-between;
}
#toast{
  position:fixed;
  right:12px;
  top:80px;
  padding:10px 14px;
  border-radius:10px;
  color:#fff;
  display:none;
  z-index:9999;
}
#toast.success{background:#2ecc71}
#toast.error{background:#e74c3c}
</style>
</head>

<body>

<div id="toast"></div>

<!-- LOGIN -->
<div id="loginScreen" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
background:linear-gradient(135deg,#fff,#ffe6f0);z-index:99999;">
  <div style="max-width:360px;width:100%;padding:22px;border-radius:16px;
  background:rgba(255,255,255,.7);box-shadow:0 10px 30px rgba(0,0,0,.15);">
    <h2 style="text-align:center;">Admin Login</h2>
    <label>Username</label>
    <input id="loginUser">
    <label style="margin-top:8px;">Password</label>
    <input id="loginPass" type="password">
    <button id="loginBtn" style="width:100%;margin-top:14px;">Login</button>
    <div id="loginError" style="display:none;color:#e74c3c;text-align:center;margin-top:10px;">
      Invalid credentials
    </div>
  </div>
</div>

<div id="adminApp" style="display:none;">

<header id="topbar">
  <h1>Attendance Admin</h1>
  <div style="display:flex;gap:10px;align-items:center;">
    <img id="logo" src="college-logo.png">
    <button id="logoutBtn" class="ghost">Logout</button>
  </div>
</header>

<main id="container">

<section class="left card">
  <h3>QR Scanner</h3>
  <label>Session</label>
  <select id="session">
    <option value="morning">Morning</option>
    <option value="afternoon">Afternoon</option>
  </select>

  <div class="controls">
    <button id="startBtn">Start Scan</button>
    <button id="stopBtn" class="ghost" disabled>Stop</button>
    <button id="resetBtn" class="ghost">Reset View</button>
  </div>

  <video id="video" autoplay muted playsinline></video>

  <div class="controls">
    <button id="exportBtn">Save CSV</button>
    <button id="printBtn">Print</button>
  </div>
</section>

<section class="right">
  <div class="card" style="display:flex;gap:10px;">
    <input id="search" placeholder="Search name | course | year">
    <div>Today: <strong id="todayLabel"></strong></div>
  </div>

  <div class="card table-wrap">
    <table>
      <thead>
        <tr>
          <th>Name</th><th>Course</th><th>Year</th>
          <th>Morning In</th><th>Morning Out</th>
          <th>Afternoon In</th><th>Afternoon Out</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div id="summaryBar">
    <div>Shown: <strong id="countShown">0</strong></div>
    <div>Total: <strong id="totalCount">0</strong></div>
  </div>
</section>

</main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* FORCE LOGOUT ON REFRESH */
const nav = performance.getEntriesByType("navigation")[0];
if(nav && nav.type === "reload"){
  sessionStorage.removeItem("adminLoggedIn");
}

/* FIREBASE */
const firebaseConfig={
  apiKey:"AIzaSyC7h8wS3Rs6rSZVjUKL8DE9NlqxD3dCIgI",
  authDomain:"dent-dept-dtr.firebaseapp.com",
  databaseURL:"https://dent-dept-dtr-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"dent-dept-dtr"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

/* TOAST */
const toast=document.getElementById("toast");
function showToast(msg,type="success"){
  toast.textContent=msg;
  toast.className=type;
  toast.style.display="block";
  setTimeout(()=>toast.style.display="none",2000);
}

/* LOGIN */
const LOGIN_USER="admin";
const LOGIN_PASS="admin123";
const loginScreen=document.getElementById("loginScreen");
const adminApp=document.getElementById("adminApp");

function showAdmin(){
  loginScreen.style.display="none";
  adminApp.style.display="block";
  render();
  startAutoLogout();
}
function showLogin(){
  adminApp.style.display="none";
  loginScreen.style.display="flex";
  sessionStorage.removeItem("adminLoggedIn");
  stopAutoLogout();
}

loginBtn.onclick=()=>{
  if(loginUser.value===LOGIN_USER && loginPass.value===LOGIN_PASS){
    sessionStorage.setItem("adminLoggedIn","true");
    showAdmin();
  }else{
    loginError.style.display="block";
  }
};
logoutBtn.onclick=showLogin;

if(sessionStorage.getItem("adminLoggedIn")==="true"){
  showAdmin();
}else{
  showLogin();
}

/* AUTO LOGOUT */
const AUTO_LOGOUT_MS=5*60*1000;
let logoutTimer;
function resetTimer(){
  clearTimeout(logoutTimer);
  logoutTimer=setTimeout(()=>{
    showToast("Logged out (inactivity)","error");
    showLogin();
  },AUTO_LOGOUT_MS);
}
function startAutoLogout(){resetTimer()}
function stopAutoLogout(){clearTimeout(logoutTimer)}
["click","mousemove","keydown","scroll","touchstart"].forEach(e=>{
  document.addEventListener(e,()=>{
    if(sessionStorage.getItem("adminLoggedIn")==="true") resetTimer();
  },{passive:true});
});

/* QR SCANNER */
const startBtn=document.getElementById("startBtn");
const stopBtn=document.getElementById("stopBtn");
const video=document.getElementById("video");
const sessionSelect=document.getElementById("session");

const codeReader=new ZXing.BrowserQRCodeReader();
let scanning=false;
let lastScan={text:null,ts:0};

async function startScanner(){
  if(scanning) return;
  const devices=await codeReader.listVideoInputDevices();
  const cam=devices.find(d=>/back|rear|env/i.test(d.label))||devices[0];
  scanning=true;
  startBtn.disabled=true;
  stopBtn.disabled=false;
  showToast("Scanner started");
  codeReader.decodeFromVideoDevice(cam.deviceId,video,(result)=>{
    if(result){
      const txt=result.getText();
      const now=Date.now();
      if(txt===lastScan.text && now-lastScan.ts<1500) return;
      lastScan={text:txt,ts:now};
      handleScan(txt);
    }
  });
}
function stopScanner(){
  codeReader.reset();
  scanning=false;
  startBtn.disabled=false;
  stopBtn.disabled=true;
  showToast("Scanner stopped");
}
startBtn.onclick=startScanner;
stopBtn.onclick=stopScanner;

/* ATTENDANCE */
const tableBody=document.getElementById("tableBody");
const searchEl=document.getElementById("search");
const todayLabel=document.getElementById("todayLabel");
const countShown=document.getElementById("countShown");
const totalCount=document.getElementById("totalCount");

todayLabel.textContent=new Date().toISOString().slice(0,10);
let tableData={};

onValue(ref(db,`attendance/${todayLabel.textContent}`),snap=>{
  tableData=snap.exists()?snap.val():{};
  render();
});

function parseQR(text){
  try{
    const j=JSON.parse(text);
    if(j.uid && (j.mode==="in"||j.mode==="out")) return j;
  }catch(e){}
  return null;
}

async function handleScan(text){
  const qr=parseQR(text);
  if(!qr){showToast("Invalid QR","error");return;}
  const uid=qr.uid;
  const mode=qr.mode;
  const date=todayLabel.textContent;
  const refUser=ref(db,`attendance/${date}/${uid}`);

  const snap=await get(refUser);
  const data=snap.exists()?snap.val():{};
  const profSnap=await get(ref(db,`users/${uid}`));
  const prof=profSnap.exists()?profSnap.val():{};
  const now=Date.now();
  const sess=sessionSelect.value;

  function save(field){
    return set(refUser,{
      ...data,
      [field]:now,
      date,
      name:prof.name||"Unknown",
      course:prof.course||"",
      year:prof.year||""
    });
  }

  if(mode==="in"){
    if(sess==="morning" && !data.morningIn){await save("morningIn");showToast("Morning In");return;}
    if(sess==="afternoon" && !data.afternoonIn){await save("afternoonIn");showToast("Afternoon In");return;}
  }
  if(mode==="out"){
    if(sess==="morning" && data.morningIn && !data.morningOut){await save("morningOut");showToast("Morning Out");return;}
    if(sess==="afternoon" && data.afternoonIn && !data.afternoonOut){await save("afternoonOut");showToast("Afternoon Out");return;}
  }
  showToast("Already recorded","error");
}

function formatTime(t){
  const d=new Date(t);
  let h=d.getHours()%12||12;
  return `${h}:${String(d.getMinutes()).padStart(2,"0")} ${d.getHours()<12?"AM":"PM"}`;
}

function render(){
  tableBody.innerHTML="";
  let shown=0;
  for(const uid in tableData){
    const r=tableData[uid];
    const hay=`${r.name} ${r.course} ${r.year}`.toLowerCase();
    if(searchEl.value && !hay.includes(searchEl.value.toLowerCase())) continue;
    tableBody.innerHTML+=`
      <tr>
        <td>${r.name||uid}</td>
        <td>${r.course||""}</td>
        <td>${r.year||""}</td>
        <td>${r.morningIn?formatTime(r.morningIn):""}</td>
        <td>${r.morningOut?formatTime(r.morningOut):""}</td>
        <td>${r.afternoonIn?formatTime(r.afternoonIn):""}</td>
        <td>${r.afternoonOut?formatTime(r.afternoonOut):""}</td>
        <td>${r.date||todayLabel.textContent}</td>
      </tr>`;
    shown++;
  }
  countShown.textContent=shown;
  totalCount.textContent=Object.keys(tableData).length;
}
searchEl.oninput=render;
resetBtn.onclick=()=>{searchEl.value="";render();showToast("View refreshed");};
</script>

</body>
    </html>
